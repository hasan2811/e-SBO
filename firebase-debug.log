[debug] [2025-06-29T19:14:38.330Z] ----------------------------------------------------------------------
[debug] [2025-06-29T19:14:38.338Z] Command:       /nix/store/rbdrkcs5kkwpalxcd7c6bnm33lk2955n-nodejs-20.19.0/bin/node /nix/store/fprgfkwna33crhc86jqbf5878piivvgw-firebase-tools-14.7.0/lib/node_modules/firebase-tools/lib/bin/firebase.js emulators:start --project=demo-app --only=auth,firestore
[debug] [2025-06-29T19:14:38.342Z] CLI Version:   14.7.0
[debug] [2025-06-29T19:14:38.342Z] Platform:      linux
[debug] [2025-06-29T19:14:38.342Z] Node Version:  v20.19.0
[debug] [2025-06-29T19:14:38.342Z] Time:          Sun Jun 29 2025 19:14:38 GMT+0000 (Coordinated Universal Time)
[debug] [2025-06-29T19:14:38.343Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-06-29T19:14:40.265Z] openjdk version "21.0.5" 2024-10-15

[debug] [2025-06-29T19:14:40.269Z] OpenJDK Runtime Environment (build 21.0.5+1-nixos)
OpenJDK 64-Bit Server VM (build 21.0.5+1-nixos, mixed mode, sharing)

[debug] [2025-06-29T19:14:40.321Z] Parsed Java major version: 21
[info] i  emulators: Starting emulators: firestore {"metadata":{"emulator":{"name":"hub"},"message":"Starting emulators: firestore"}}
[info] i  emulators: Detected demo project ID "demo-app", emulated services will use a demo configuration and attempts to access non-emulated services for this project will fail. {"metadata":{"emulator":{"name":"hub"},"message":"Detected demo project ID \"demo-app\", emulated services will use a demo configuration and attempts to access non-emulated services for this project will fail."}}
[warn] ⚠  auth: Not starting the auth emulator, make sure you have run firebase init. {"metadata":{"emulator":{"name":"auth"},"message":"Not starting the auth emulator, make sure you have run firebase init."}}
[warn] ⚠  hub: Error when trying to check port 4400 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4400 {"metadata":{"emulator":{"name":"hub"},"message":"Error when trying to check port 4400 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4400"}}
[warn] ⚠  hub: Port 4400 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"hub"},"message":"Port 4400 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  hub: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"hub"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  ui: Error when trying to check port 4000 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4000 {"metadata":{"emulator":{"name":"ui"},"message":"Error when trying to check port 4000 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4000"}}
[warn] ⚠  ui: Port 4000 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"ui"},"message":"Port 4000 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  ui: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"ui"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  logging: Error when trying to check port 4500 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4500 {"metadata":{"emulator":{"name":"logging"},"message":"Error when trying to check port 4500 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4500"}}
[warn] ⚠  logging: Port 4500 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"logging"},"message":"Port 4500 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  logging: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"logging"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  firestore: Error when trying to check port 8080 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:8080 {"metadata":{"emulator":{"name":"firestore"},"message":"Error when trying to check port 8080 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:8080"}}
[warn] ⚠  firestore: Port 8080 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"firestore"},"message":"Port 8080 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  firestore: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"firestore"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  firestore.websocket: Error when trying to check port 9150 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:9150 {"metadata":{"emulator":{"name":"firestore"},"message":"Error when trying to check port 9150 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:9150"}}
[warn] ⚠  firestore: Port 9150 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"firestore"},"message":"Port 9150 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  firestore: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"firestore"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[debug] [2025-06-29T19:14:40.341Z] assigned listening specs for emulators {"user":{"hub":[{"address":"127.0.0.1","family":"IPv4","port":4400}],"ui":[{"address":"127.0.0.1","family":"IPv4","port":4000}],"logging":[{"address":"127.0.0.1","family":"IPv4","port":4500}],"firestore":[{"address":"127.0.0.1","family":"IPv4","port":8080}],"firestore.websocket":[{"address":"127.0.0.1","family":"IPv4","port":9150}]},"metadata":{"message":"assigned listening specs for emulators"}}
[debug] [2025-06-29T19:14:40.352Z] [hub] writing locator at /tmp/hub-demo-app.json
[debug] [2025-06-29T19:14:40.377Z] Ignoring unsupported arg: auto_download {"metadata":{"emulator":{"name":"firestore"},"message":"Ignoring unsupported arg: auto_download"}}
[debug] [2025-06-29T19:14:40.377Z] Ignoring unsupported arg: single_project_mode_error {"metadata":{"emulator":{"name":"firestore"},"message":"Ignoring unsupported arg: single_project_mode_error"}}
[debug] [2025-06-29T19:14:40.378Z] Starting Firestore Emulator with command {"binary":"java","args":["-Dgoogle.cloud_firestore.debug_log_level=FINE","-Duser.language=en","-jar","/nix/store/w60wgw0k95kiq4yl5f561xhydyg07gf7-emulators/cloud-firestore-emulator-v1.19.8.jar","--host","127.0.0.1","--port",8080,"--websocket_port",9150,"--project_id","demo-app","--rules","/home/user/studio/firestore.rules","--single_project_mode",true],"optionalArgs":["port","webchannel_port","host","rules","websocket_port","functions_emulator","seed_from_export","project_id","single_project_mode"],"joinArgs":false,"shell":false,"port":8080} {"metadata":{"emulator":{"name":"firestore"},"message":"Starting Firestore Emulator with command {\"binary\":\"java\",\"args\":[\"-Dgoogle.cloud_firestore.debug_log_level=FINE\",\"-Duser.language=en\",\"-jar\",\"/nix/store/w60wgw0k95kiq4yl5f561xhydyg07gf7-emulators/cloud-firestore-emulator-v1.19.8.jar\",\"--host\",\"127.0.0.1\",\"--port\",8080,\"--websocket_port\",9150,\"--project_id\",\"demo-app\",\"--rules\",\"/home/user/studio/firestore.rules\",\"--single_project_mode\",true],\"optionalArgs\":[\"port\",\"webchannel_port\",\"host\",\"rules\",\"websocket_port\",\"functions_emulator\",\"seed_from_export\",\"project_id\",\"single_project_mode\"],\"joinArgs\":false,\"shell\":false,\"port\":8080}"}}
[info] i  firestore: Firestore Emulator logging to firestore-debug.log {"metadata":{"emulator":{"name":"firestore"},"message":"Firestore Emulator logging to firestore-debug.log"}}
[debug] [2025-06-29T19:14:45.732Z] Jun 29, 2025 7:14:45 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketServer start
INFO: Started WebSocket server on ws://127.0.0.1:9150
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 7:14:45 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketServer start\nINFO: Started WebSocket server on ws://127.0.0.1:9150\n"}}
[debug] [2025-06-29T19:14:45.817Z] API endpoint: http://127.0.0.1:8080
If you are using a library that supports the FIRESTORE_EMULATOR_HOST environment variable, run:

   export FIRESTORE_EMULATOR_HOST=127.0.0.1:8080

If you are running a Firestore in Datastore Mode project, run:

   export DATASTORE_EMULATOR_HOST=127.0.0.1:8080

 {"metadata":{"emulator":{"name":"firestore"},"message":"API endpoint: http://127.0.0.1:8080\nIf you are using a library that supports the FIRESTORE_EMULATOR_HOST environment variable, run:\n\n   export FIRESTORE_EMULATOR_HOST=127.0.0.1:8080\n\nIf you are running a Firestore in Datastore Mode project, run:\n\n   export DATASTORE_EMULATOR_HOST=127.0.0.1:8080\n\n"}}
[debug] [2025-06-29T19:14:45.817Z] Note: Support for Datastore Mode is in preview. If you encounter any bugs please file at https://github.com/firebase/firebase-tools/issues.
Dev App Server is now running.

 {"metadata":{"emulator":{"name":"firestore"},"message":"Note: Support for Datastore Mode is in preview. If you encounter any bugs please file at https://github.com/firebase/firebase-tools/issues.\nDev App Server is now running.\n\n"}}
[info] ✔  firestore: Firestore Emulator UI websocket is running on 9150. {"metadata":{"emulator":{"name":"firestore"},"message":"Firestore Emulator UI websocket is running on 9150."}}
[debug] [2025-06-29T19:14:45.965Z] Could not find VSCode notification endpoint: FetchError: request to http://localhost:40001/vscode/notify failed, reason: connect ECONNREFUSED 127.0.0.1:40001. If you are not running the Firebase Data Connect VSCode extension, this is expected and not an issue.
[info] 
┌─────────────────────────────────────────────────────────────┐
│ ✔  All emulators ready! It is now safe to connect your app. │
│ i  View Emulator UI at http://127.0.0.1:4000/               │
└─────────────────────────────────────────────────────────────┘

┌───────────┬────────────────┬─────────────────────────────────┐
│ Emulator  │ Host:Port      │ View in Emulator UI             │
├───────────┼────────────────┼─────────────────────────────────┤
│ Firestore │ 127.0.0.1:8080 │ http://127.0.0.1:4000/firestore │
└───────────┴────────────────┴─────────────────────────────────┘
  Emulator Hub host: 127.0.0.1 port: 4400
  Other reserved ports: 4500, 9150

Issues? Report them at https://github.com/firebase/firebase-tools/issues and attach the *-debug.log files.
 
[debug] [2025-06-29T19:14:46.757Z] Jun 29, 2025 7:14:46 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 7:14:46 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-06-29T19:14:47.606Z] Jun 29, 2025 7:14:47 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 7:14:47 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-06-29T19:14:48.106Z] Jun 29, 2025 7:14:48 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 7:14:48 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-06-29T19:14:48.621Z] Jun 29, 2025 7:14:48 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 7:14:48 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-06-29T19:14:49.147Z] Jun 29, 2025 7:14:49 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 7:14:49 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-06-29T19:14:49.742Z] Jun 29, 2025 7:14:49 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 7:14:49 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[debug] [2025-06-29T19:14:50.963Z] Jun 29, 2025 7:14:50 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel
INFO: Connected to new websocket client
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 7:14:50 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler initChannel\nINFO: Connected to new websocket client\n"}}
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-29T19:15:06.439Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-29T19:15:06.454Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Users can only read and update their own profile.\n    match /users/{userId} {\n      allow read, update: if request.auth != null && request.auth.uid == userId;\n      allow create: if request.auth != null;\n    }\n\n    // Rules for Observations\n    match /observations/{observationId} {\n      // Allow any authenticated user to read public observations\n      // or observations they own.\n      allow read: if request.auth != null && (resource.data.scope == 'public' || request.auth.uid == resource.data.userId);\n      \n      // Allow any authenticated user to create an observation.\n      allow create: if request.auth != null;\n      \n      // Only the owner can update or delete their observation.\n      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;\n    }\n\n    // Rules for Inspections. These are treated as public for now.\n    match /inspections/{inspectionId} {\n      // Allow any authenticated user to read or create.\n      allow read, create: if request.auth != null;\n      \n      // Only the owner can update or delete.\n      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;\n    }\n\n    // Rules for PTWs\n    match /ptws/{ptwId} {\n      // Allow any authenticated user to read public PTWs\n      // or PTWs they own.\n      allow read: if request.auth != null && (resource.data.scope == 'public' || request.auth.uid == resource.data.userId);\n      \n      // Allow any authenticated user to create.\n      allow create: if request.auth != null;\n      \n      // Only the owner can update or delete. (Approver rules can be added later).\n      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-29T19:15:06.583Z] Jun 29, 2025 7:15:06 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 7:15:06 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-29T19:15:08.947Z] Jun 29, 2025 7:15:08 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 7:15:08 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected HTTP/2 connection.\n"}}
[debug] [2025-06-29T19:15:16.862Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-29T19:15:16.871Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-29T20:13:51.075Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-29T20:13:51.080Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Users can only manage their own profile\n    match /users/{userId} {\n      allow read, update: if request.auth != null && request.auth.uid == userId;\n      allow create: if request.auth != null;\n    }\n\n    // Rules for Observations\n    match /observations/{docId} {\n      allow read: if resource.data.scope == 'public' || (request.auth != null && resource.data.userId == request.auth.uid);\n      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;\n      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;\n    }\n    \n    // Rules for Inspections\n    match /inspections/{docId} {\n      allow read: if resource.data.scope == 'public' || (request.auth != null && resource.data.userId == request.auth.uid);\n      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;\n      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;\n    }\n\n    // Rules for PTWs\n    match /ptws/{docId} {\n      allow read: if resource.data.scope == 'public' || (request.auth != null && resource.data.userId == request.auth.uid);\n      // Anyone authenticated can approve a PTW, but only owner can create/delete\n      allow create, delete: if request.auth != null && request.resource.data.userId == request.auth.uid;\n      allow update: if request.auth != null && (resource.data.userId == request.auth.uid || request.resource.data.status == 'Approved');\n    }\n  }\n}\n"}]}}
[debug] [2025-06-29T20:13:51.119Z] Jun 29, 2025 8:13:51 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 8:13:51 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-29T20:13:51.219Z] Jun 29, 2025 8:13:51 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 8:13:51 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected HTTP/2 connection.\n"}}
[debug] [2025-06-29T20:13:51.694Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-29T20:13:51.698Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[debug] [2025-06-29T20:31:44.387Z] Jun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\n"}}
[debug] [2025-06-29T20:31:44.391Z] Jun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
Jun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\nJun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\n"}}
[debug] [2025-06-29T20:31:44.403Z] Jun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\n"}}
[debug] [2025-06-29T20:31:44.411Z] Jun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
Jun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\nJun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\n"}}
[debug] [2025-06-29T20:31:44.426Z] Jun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed
INFO: Websocket client disconnected
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 8:31:44 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketChannelHandler channelClosed\nINFO: Websocket client disconnected\n"}}
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-29T21:02:06.114Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-29T21:02:06.115Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n  \n    // Users can read and write their own profile\n    match /users/{userId} {\n      allow read, write: if request.auth.uid == userId;\n    }\n\n    // Rules for observations\n    match /observations/{obsId} {\n      allow create: if request.auth != null;\n      allow read: if resource.data.scope == 'public' || request.auth.uid == resource.data.userId;\n      allow update, delete: if request.auth.uid == resource.data.userId;\n    }\n\n    // Rules for inspections\n    match /inspections/{inspId} {\n      allow create: if request.auth != null;\n      allow read: if resource.data.scope == 'public' || request.auth.uid == resource.data.userId;\n      allow update, delete: if request.auth.uid == resource.data.userId;\n    }\n    \n    // Rules for PTWs\n    match /ptws/{ptwId} {\n      allow create: if request.auth != null;\n      allow read: if resource.data.scope == 'public' || request.auth.uid == resource.data.userId;\n      allow update, delete: if request.auth.uid == resource.data.userId;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-29T21:02:06.186Z] Jun 29, 2025 9:02:06 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 9:02:06 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-29T21:02:06.326Z] Jun 29, 2025 9:02:06 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 29, 2025 9:02:06 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected HTTP/2 connection.\n"}}
[debug] [2025-06-29T21:02:07.011Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-29T21:02:07.027Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[debug] [2025-06-30T04:31:45.139Z] ----------------------------------------------------------------------
[debug] [2025-06-30T04:31:45.144Z] Command:       /nix/store/rbdrkcs5kkwpalxcd7c6bnm33lk2955n-nodejs-20.19.0/bin/node /nix/store/fprgfkwna33crhc86jqbf5878piivvgw-firebase-tools-14.7.0/lib/node_modules/firebase-tools/lib/bin/firebase.js emulators:start --project=demo-app --only=auth,firestore
[debug] [2025-06-30T04:31:45.145Z] CLI Version:   14.7.0
[debug] [2025-06-30T04:31:45.145Z] Platform:      linux
[debug] [2025-06-30T04:31:45.146Z] Node Version:  v20.19.0
[debug] [2025-06-30T04:31:45.146Z] Time:          Mon Jun 30 2025 04:31:45 GMT+0000 (Coordinated Universal Time)
[debug] [2025-06-30T04:31:45.146Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-06-30T04:31:46.871Z] openjdk version "21.0.5" 2024-10-15
OpenJDK Runtime Environment (build 21.0.5+1-nixos)
OpenJDK 64-Bit Server VM (build 21.0.5+1-nixos, mixed mode, sharing)

[debug] [2025-06-30T04:31:46.938Z] Parsed Java major version: 21
[info] i  emulators: Starting emulators: firestore {"metadata":{"emulator":{"name":"hub"},"message":"Starting emulators: firestore"}}
[info] i  emulators: Detected demo project ID "demo-app", emulated services will use a demo configuration and attempts to access non-emulated services for this project will fail. {"metadata":{"emulator":{"name":"hub"},"message":"Detected demo project ID \"demo-app\", emulated services will use a demo configuration and attempts to access non-emulated services for this project will fail."}}
[warn] ⚠  auth: Not starting the auth emulator, make sure you have run firebase init. {"metadata":{"emulator":{"name":"auth"},"message":"Not starting the auth emulator, make sure you have run firebase init."}}
[warn] ⚠  hub: Error when trying to check port 4400 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4400 {"metadata":{"emulator":{"name":"hub"},"message":"Error when trying to check port 4400 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4400"}}
[warn] ⚠  hub: Port 4400 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"hub"},"message":"Port 4400 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  hub: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"hub"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  ui: Error when trying to check port 4000 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4000 {"metadata":{"emulator":{"name":"ui"},"message":"Error when trying to check port 4000 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4000"}}
[warn] ⚠  ui: Port 4000 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"ui"},"message":"Port 4000 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  ui: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"ui"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  logging: Error when trying to check port 4500 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4500 {"metadata":{"emulator":{"name":"logging"},"message":"Error when trying to check port 4500 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4500"}}
[warn] ⚠  logging: Port 4500 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"logging"},"message":"Port 4500 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  logging: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"logging"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  firestore: Error when trying to check port 8080 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:8080 {"metadata":{"emulator":{"name":"firestore"},"message":"Error when trying to check port 8080 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:8080"}}
[warn] ⚠  firestore: Port 8080 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"firestore"},"message":"Port 8080 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  firestore: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"firestore"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  firestore.websocket: Error when trying to check port 9150 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:9150 {"metadata":{"emulator":{"name":"firestore"},"message":"Error when trying to check port 9150 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:9150"}}
[warn] ⚠  firestore: Port 9150 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"firestore"},"message":"Port 9150 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  firestore: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"firestore"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[debug] [2025-06-30T04:31:47.000Z] assigned listening specs for emulators {"user":{"hub":[{"address":"127.0.0.1","family":"IPv4","port":4400}],"ui":[{"address":"127.0.0.1","family":"IPv4","port":4000}],"logging":[{"address":"127.0.0.1","family":"IPv4","port":4500}],"firestore":[{"address":"127.0.0.1","family":"IPv4","port":8080}],"firestore.websocket":[{"address":"127.0.0.1","family":"IPv4","port":9150}]},"metadata":{"message":"assigned listening specs for emulators"}}
[debug] [2025-06-30T04:31:47.016Z] [hub] writing locator at /tmp/hub-demo-app.json
[debug] [2025-06-30T04:31:47.051Z] Ignoring unsupported arg: auto_download {"metadata":{"emulator":{"name":"firestore"},"message":"Ignoring unsupported arg: auto_download"}}
[debug] [2025-06-30T04:31:47.051Z] Ignoring unsupported arg: single_project_mode_error {"metadata":{"emulator":{"name":"firestore"},"message":"Ignoring unsupported arg: single_project_mode_error"}}
[debug] [2025-06-30T04:31:47.052Z] Starting Firestore Emulator with command {"binary":"java","args":["-Dgoogle.cloud_firestore.debug_log_level=FINE","-Duser.language=en","-jar","/nix/store/w60wgw0k95kiq4yl5f561xhydyg07gf7-emulators/cloud-firestore-emulator-v1.19.8.jar","--host","127.0.0.1","--port",8080,"--websocket_port",9150,"--project_id","demo-app","--rules","/home/user/studio/firestore.rules","--single_project_mode",true],"optionalArgs":["port","webchannel_port","host","rules","websocket_port","functions_emulator","seed_from_export","project_id","single_project_mode"],"joinArgs":false,"shell":false,"port":8080} {"metadata":{"emulator":{"name":"firestore"},"message":"Starting Firestore Emulator with command {\"binary\":\"java\",\"args\":[\"-Dgoogle.cloud_firestore.debug_log_level=FINE\",\"-Duser.language=en\",\"-jar\",\"/nix/store/w60wgw0k95kiq4yl5f561xhydyg07gf7-emulators/cloud-firestore-emulator-v1.19.8.jar\",\"--host\",\"127.0.0.1\",\"--port\",8080,\"--websocket_port\",9150,\"--project_id\",\"demo-app\",\"--rules\",\"/home/user/studio/firestore.rules\",\"--single_project_mode\",true],\"optionalArgs\":[\"port\",\"webchannel_port\",\"host\",\"rules\",\"websocket_port\",\"functions_emulator\",\"seed_from_export\",\"project_id\",\"single_project_mode\"],\"joinArgs\":false,\"shell\":false,\"port\":8080}"}}
[info] i  firestore: Firestore Emulator logging to firestore-debug.log {"metadata":{"emulator":{"name":"firestore"},"message":"Firestore Emulator logging to firestore-debug.log"}}
[debug] [2025-06-30T04:31:54.912Z] Jun 30, 2025 4:31:54 AM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketServer start
INFO: Started WebSocket server on ws://127.0.0.1:9150
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 4:31:54 AM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketServer start\nINFO: Started WebSocket server on ws://127.0.0.1:9150\n"}}
[debug] [2025-06-30T04:31:55.340Z] API endpoint: http://127.0.0.1:8080
If you are using a library that supports the FIRESTORE_EMULATOR_HOST environment variable, run:

   export FIRESTORE_EMULATOR_HOST=127.0.0.1:8080

If you are running a Firestore in Datastore Mode project, run:
 {"metadata":{"emulator":{"name":"firestore"},"message":"API endpoint: http://127.0.0.1:8080\nIf you are using a library that supports the FIRESTORE_EMULATOR_HOST environment variable, run:\n\n   export FIRESTORE_EMULATOR_HOST=127.0.0.1:8080\n\nIf you are running a Firestore in Datastore Mode project, run:\n"}}
[debug] [2025-06-30T04:31:55.346Z] 
   export DATASTORE_EMULATOR_HOST=127.0.0.1:8080

Note: Support for Datastore Mode is in preview. If you encounter any bugs please file at https://github.com/firebase/firebase-tools/issues.
Dev App Server is now running.

 {"metadata":{"emulator":{"name":"firestore"},"message":"\n   export DATASTORE_EMULATOR_HOST=127.0.0.1:8080\n\nNote: Support for Datastore Mode is in preview. If you encounter any bugs please file at https://github.com/firebase/firebase-tools/issues.\nDev App Server is now running.\n\n"}}
[info] ✔  firestore: Firestore Emulator UI websocket is running on 9150. {"metadata":{"emulator":{"name":"firestore"},"message":"Firestore Emulator UI websocket is running on 9150."}}
[debug] [2025-06-30T04:31:55.747Z] Could not find VSCode notification endpoint: FetchError: request to http://localhost:40001/vscode/notify failed, reason: connect ECONNREFUSED 127.0.0.1:40001. If you are not running the Firebase Data Connect VSCode extension, this is expected and not an issue.
[info] 
┌─────────────────────────────────────────────────────────────┐
│ ✔  All emulators ready! It is now safe to connect your app. │
│ i  View Emulator UI at http://127.0.0.1:4000/               │
└─────────────────────────────────────────────────────────────┘

┌───────────┬────────────────┬─────────────────────────────────┐
│ Emulator  │ Host:Port      │ View in Emulator UI             │
├───────────┼────────────────┼─────────────────────────────────┤
│ Firestore │ 127.0.0.1:8080 │ http://127.0.0.1:4000/firestore │
└───────────┴────────────────┴─────────────────────────────────┘
  Emulator Hub host: 127.0.0.1 port: 4400
  Other reserved ports: 4500, 9150

Issues? Report them at https://github.com/firebase/firebase-tools/issues and attach the *-debug.log files.
 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T04:32:12.801Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T04:32:12.811Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n  \n    // Users can read and write their own profile\n    match /users/{userId} {\n      allow read, write: if request.auth.uid == userId;\n    }\n\n    // Rules for observations\n    match /observations/{obsId} {\n      allow create: if request.auth != null;\n      allow read: if resource.data.scope == 'public' || request.auth.uid == resource.data.userId;\n      allow update, delete: if request.auth.uid == resource.data.userId;\n    }\n\n    // Rules for inspections\n    match /inspections/{inspId} {\n      allow create: if request.auth != null;\n      allow read: if resource.data.scope == 'public' || request.auth.uid == resource.data.userId;\n      allow update, delete: if request.auth.uid == resource.data.userId;\n    }\n    \n    // Rules for PTWs\n    match /ptws/{ptwId} {\n      allow create: if request.auth != null;\n      allow read: if resource.data.scope == 'public' || request.auth.uid == resource.data.userId;\n      allow update, delete: if request.auth.uid == resource.data.userId;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T04:32:12.971Z] Jun 30, 2025 4:32:12 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 4:32:12 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T04:32:16.080Z] Jun 30, 2025 4:32:16 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 4:32:16 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected HTTP/2 connection.\n"}}
[debug] [2025-06-30T04:32:26.272Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T04:32:26.277Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T04:37:11.033Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T04:37:11.033Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Users can only read and modify their own profile document.\n    match /users/{userId} {\n      allow read, update, create: if request.auth != null && request.auth.uid == userId;\n    }\n\n    // --- Helper Functions ---\n\n    // A user can read any document that is public, OR any document they own.\n    // This single rule covers both the public feed query and the private feed query.\n    function canRead(docData) {\n      return request.auth != null && (docData.userId == request.auth.uid || docData.scope == 'public');\n    }\n    \n    // A user can only write/modify a document they own.\n    function isOwner(docData) {\n      return request.auth != null && docData.userId == request.auth.uid;\n    }\n    \n    // --- Collection Rules ---\n    \n    match /observations/{docId} {\n      allow read: if canRead(resource.data);\n      allow create: if request.auth != null; // Any authenticated user can create.\n      allow update, delete: if isOwner(resource.data);\n    }\n\n    match /inspections/{docId} {\n      allow read: if canRead(resource.data);\n      allow create: if request.auth != null;\n      allow update, delete: if isOwner(resource.data);\n    }\n\n    match /ptws/{docId} {\n      allow read: if canRead(resource.data);\n      allow create: if request.auth != null;\n      allow update, delete: if isOwner(resource.data);\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T04:37:11.052Z] Jun 30, 2025 4:37:11 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 4:37:11 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T04:37:11.465Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T04:37:11.465Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T04:50:08.165Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T04:50:08.170Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper function to check if a user is authenticated\n    function isAuthenticated() {\n      return request.auth != null;\n    }\n\n    // Helper function to check if a user is the owner of a data document\n    function isOwner(userId) {\n      return request.auth.uid == userId;\n    }\n\n    // Rule for the 'users' collection\n    match /users/{userId} {\n      // Any authenticated user can read profile data (for names, etc.)\n      allow read: if isAuthenticated();\n      // Only the owner can update their own profile\n      allow write: if request.auth.uid == userId;\n    }\n\n    // Generic rule for data collections (observations, inspections, ptws)\n    match /{dataCollection}/{docId}\n      where dataCollection in ['observations', 'inspections', 'ptws'] {\n      \n      // READ:\n      // A user can read a document if:\n      // 1. It is marked as 'public'\n      // 2. OR they are the owner of the document.\n      allow read: if resource.data.scope == 'public' || isOwner(resource.data.userId);\n\n      // CREATE:\n      // A user can create a document if:\n      // 1. They are authenticated.\n      // 2. They are the owner specified in the new document.\n      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);\n\n      // UPDATE:\n      // A user can update a document if:\n      // 1. They are authenticated.\n      // 2. They are the owner of the document being updated.\n      allow update: if isAuthenticated() && isOwner(resource.data.userId);\n\n      // DELETE:\n      // Deletes are disallowed to preserve data integrity.\n      allow delete: if false;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T04:50:08.190Z] Jun 30, 2025 4:50:08 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 4:50:08 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T04:50:08.394Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T04:50:08.400Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":25,"column":11,"currentOffset":752,"endOffset":752},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":26,"column":7,"currentOffset":784,"endOffset":788},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":26,"column":7,"currentOffset":784,"endOffset":788},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":51,"column":1,"currentOffset":1679,"endOffset":1679},"description":"Unexpected '}'.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:25:11 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:26:7 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:26:7 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:51:1 - ERROR Unexpected '}'. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T05:13:01.964Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T05:13:01.965Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper function to check if a user is authenticated\n    function isAuthenticated() {\n      return request.auth != null;\n    }\n\n    // Helper function to check if a user is a member of a project\n    function isProjectMember(projectId) {\n      // Use get() for checking single documents, typically in `allow get` rules.\n      let projectData = get(/databases/$(database)/documents/projects/$(projectId)).data;\n      return isAuthenticated() && ('memberUids' in projectData) && request.auth.uid in projectData.memberUids;\n    }\n\n    // Profiles: Users can read any profile but only update their own.\n    match /users/{userId} {\n      allow read, create: if isAuthenticated();\n      allow update: if isAuthenticated() && request.auth.uid == userId;\n    }\n\n    // Projects: Users can create projects. They can read projects they are a member of.\n    match /projects/{projectId} {\n      allow create: if isAuthenticated();\n      // This rule is now more robust. It checks for the existence of 'memberUids'.\n      // This supports the 'array-contains' query used in the app.\n      allow read: if isAuthenticated() && 'memberUids' in resource.data && request.auth.uid in resource.data.memberUids;\n    }\n\n    // Generic rule for collections (observations, inspections, ptws)\n    match /{collection}/{docId}\n      where collection in ['observations', 'inspections', 'ptws'] {\n\n      allow create: if isAuthenticated();\n      allow update: if isAuthenticated() && request.auth.uid == resource.data.userId;\n\n      // Allow reading documents under these conditions:\n      // 1. The document is public.\n      // 2. The user is the owner of the document.\n      // 3. The document belongs to a project the user is a member of.\n      // This rule works for both single `get` requests and collection `list` queries\n      // as long as the queries are structured correctly (which we will ensure in the app).\n      allow read: if resource.data.scope == 'public'\n                   || (isAuthenticated() && request.auth.uid == resource.data.userId)\n                   || (isAuthenticated() && resource.data.scope == 'project' && isProjectMember(resource.data.projectId));\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T05:13:02.002Z] Jun 30, 2025 5:13:01 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 5:13:01 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T05:13:02.315Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T05:13:02.324Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":34,"column":11,"currentOffset":1375,"endOffset":1375},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":35,"column":7,"currentOffset":1403,"endOffset":1407},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":35,"column":7,"currentOffset":1403,"endOffset":1407},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":51,"column":1,"currentOffset":2260,"endOffset":2260},"description":"Unexpected '}'.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:34:11 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:35:7 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:35:7 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:51:1 - ERROR Unexpected '}'. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T07:39:17.549Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T07:39:17.550Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    \n    // Users can manage their own profile.\n    // Authenticated users can query the users collection to find others by email for invitations.\n    match /users/{userId} {\n      allow read: if request.auth != null;\n      allow write: if request.auth.uid == userId;\n    }\n\n    // Projects can be read by members.\n    // The owner can update/delete it.\n    // An authenticated user can create a project and becomes the owner.\n    match /projects/{projectId} {\n      allow read: if request.auth.uid in resource.data.memberUids;\n      allow create: if request.auth.uid != null && request.auth.uid == request.resource.data.ownerUid;\n      allow update, delete: if request.auth.uid == resource.data.ownerUid;\n    }\n\n    // Generic rules for collections that can be public, private, or project-scoped.\n    match /{collectionName}/{docId} \n        where collectionName in ['observations', 'inspections', 'ptws'] {\n          \n      // Helper function to check for project membership.\n      function isMember() {\n        return request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.memberUids;\n      }\n      \n      // Allow reads based on scope: public, user's own, or project member.\n      allow read: if resource.data.scope == 'public'\n                  || (request.auth != null && request.auth.uid == resource.data.userId)\n                  || (resource.data.scope == 'project' && resource.data.projectId != null && isMember());\n\n      // Allow creation if the user is the one submitting.\n      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;\n\n      // Allow updates from the owner or any project member for observations and PTWs.\n      allow update: if (collectionName == 'observations' || collectionName == 'ptws')\n                    && request.auth != null\n                    && (request.auth.uid == resource.data.userId || (resource.data.scope == 'project' && resource.data.projectId != null && isMember()));\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T07:39:17.798Z] Jun 30, 2025 7:39:17 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 7:39:17 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T07:39:18.062Z] Jun 30, 2025 7:39:18 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 7:39:18 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected HTTP/2 connection.\n"}}
[debug] [2025-06-30T07:39:18.601Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T07:39:18.602Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":22,"column":11,"currentOffset":897,"endOffset":897},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":23,"column":9,"currentOffset":932,"endOffset":936},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":23,"column":9,"currentOffset":932,"endOffset":936},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":44,"column":1,"currentOffset":2098,"endOffset":2098},"description":"Unexpected '}'.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:22:11 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:23:9 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:23:9 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:44:1 - ERROR Unexpected '}'. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T07:49:04.858Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T07:49:04.858Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Users:\n    // - Authenticated users can read/list user profiles to enable invites by email.\n    // - Users can only write to their own document.\n    match /users/{userId} {\n      allow read, list: if request.auth != null;\n      allow write: if request.auth.uid == userId;\n    }\n\n    // Projects:\n    // - A user can read a project document if they are a member.\n    // - Any authenticated user can create a project.\n    // - Only the owner can update a project.\n    match /projects/{projectId} {\n      allow read: if request.auth.uid in resource.data.memberUids;\n      allow create: if request.auth != null;\n      allow update: if request.auth.uid == resource.data.ownerUid;\n      allow delete: if false; // Deleting projects is not allowed.\n    }\n\n    // A function to check read access for items (observations, inspections, ptws).\n    function canReadItem(item) {\n      return item.scope == 'public' ||\n             (request.auth != null && (\n               (item.scope == 'private' && request.auth.uid == item.userId) ||\n               (item.scope == 'project' && item.projectId != null && request.auth.uid in get(/databases/$(database)/documents/projects/$(item.projectId)).data.memberUids)\n             ));\n    }\n\n    // Observations\n    match /observations/{obsId} {\n      allow read: if canReadItem(resource.data);\n      allow create: if request.auth != null;\n      allow update: if request.auth.uid == resource.data.userId;\n      allow delete: if false;\n    }\n\n    // Inspections\n    match /inspections/{inspId} {\n      allow read: if canReadItem(resource.data);\n      allow create: if request.auth != null;\n      allow update: if request.auth.uid == resource.data.userId;\n      allow delete: if false;\n    }\n    \n    // Permits to Work (PTW)\n    match /ptws/{ptwId} {\n      allow read: if canReadItem(resource.data);\n      allow create: if request.auth != null;\n      // Allow updates from any authenticated user to handle approvals.\n      // In a real-world scenario, this would be more locked down (e.g., to project managers).\n      allow update: if request.auth != null;\n      allow delete: if false;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T07:49:04.879Z] Jun 30, 2025 7:49:04 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 7:49:04 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T07:49:05.795Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T07:49:05.798Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T07:53:03.188Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T07:53:03.188Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper function to check if a user is authenticated\n    function isAuthenticated() {\n      return request.auth != null;\n    }\n\n    // Helper function to check if a user is the owner of a document\n    function isOwner(userId) {\n      return request.auth.uid == userId;\n    }\n\n    // --- Users Collection ---\n    // Users can read their own profile.\n    // Authenticated users can query the collection to find users by email for invites.\n    // Users can create and update their own profile.\n    match /users/{userId} {\n      allow read, list: if isAuthenticated(); // Allow querying for project invites\n      allow create: if isOwner(userId);\n      allow update: if isOwner(userId);\n      allow delete: if false;\n    }\n\n    // --- Projects Collection ---\n    // Users can create projects.\n    // Users can read projects they are a member of.\n    // The project owner can update a project (e.g., to add members).\n    match /projects/{projectId} {\n      allow read: if isAuthenticated() && resource.data.memberUids.hasAny([request.auth.uid]);\n      allow create: if isAuthenticated();\n      allow update: if isAuthenticated() && resource.data.ownerUid == request.auth.uid;\n      allow delete: if false;\n    }\n    \n    // --- Access Control Function for Items ---\n    // Determines if a user can read an observation, inspection, or PTW.\n    function canAccessItem(itemData) {\n      let isPublic = itemData.scope == 'public';\n      let isItemOwner = itemData.userId == request.auth.uid;\n      let isProjectMember = itemData.scope == 'project' \n        && itemData.projectId != null\n        && get(/databases/$(database)/documents/projects/$(itemData.projectId)).data.memberUids.hasAny([request.auth.uid]);\n      \n      return isAuthenticated() && (isPublic || isItemOwner || isProjectMember);\n    }\n\n    // --- Observations Collection ---\n    match /observations/{observationId} {\n      allow read: if canAccessItem(resource.data);\n      allow create, update: if isAuthenticated() && isOwner(request.resource.data.userId);\n      allow delete: if false;\n    }\n    \n    // --- Inspections Collection ---\n    match /inspections/{inspectionId} {\n      allow read: if canAccessItem(resource.data);\n      allow create, update: if isAuthenticated() && isOwner(request.resource.data.userId);\n      allow delete: if false;\n    }\n\n    // --- PTWs Collection ---\n    match /ptws/{ptwId} {\n      allow read: if canAccessItem(resource.data);\n      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);\n      // Anyone authenticated can approve, this is handled in app logic.\n      // In a real scenario, you might check for a specific role.\n      allow update: if isAuthenticated(); \n      allow delete: if false;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T07:53:03.237Z] Jun 30, 2025 7:53:03 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 7:53:03 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T07:53:03.691Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T07:53:03.693Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T08:08:00.748Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T08:08:00.748Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Users can manage their own profile. Authenticated users can read limited fields of others for invites.\n    match /users/{userId} {\n      allow read: if request.auth != null;\n      allow write: if request.auth.uid == userId;\n    }\n\n    // Projects can be created by any authenticated user. Members can read/write.\n    match /projects/{projectId} {\n      allow read, update, delete: if request.auth.uid in resource.data.memberUids;\n      allow create: if request.auth != null;\n    }\n\n    // --- Data collections: Observations, Inspections, PTWs ---\n\n    // Helper function to check if user is a member of a project\n    function isProjectMember(projectId) {\n      return request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids;\n    }\n    \n    match /observations/{docId} {\n      allow read: if resource.data.scope == 'public' || \n                   request.auth.uid == resource.data.userId || \n                   (resource.data.scope == 'project' && isProjectMember(resource.data.projectId));\n      allow create: if request.auth != null;\n      // Allow the creator OR any project member to update the observation (e.g., take action)\n      allow update: if request.auth.uid == resource.data.userId || \n                     (resource.data.scope == 'project' && isProjectMember(resource.data.projectId));\n    }\n    \n    match /inspections/{docId} {\n      allow read: if resource.data.scope == 'public' || \n                   request.auth.uid == resource.data.userId ||\n                   (resource.data.scope == 'project' && isProjectMember(resource.data.projectId));\n      allow create: if request.auth != null;\n      allow update: if request.auth.uid == resource.data.userId ||\n                     (resource.data.scope == 'project' && isProjectMember(resource.data.projectId));\n    }\n    \n    match /ptws/{docId} {\n      allow read: if resource.data.scope == 'public' ||\n                   request.auth.uid == resource.data.userId ||\n                   (resource.data.scope == 'project' && isProjectMember(resource.data.projectId));\n      allow create: if request.auth != null;\n      // Allow the creator OR any project member to update the PTW (e.g., approve)\n      allow update: if request.auth.uid == resource.data.userId ||\n                     (resource.data.scope == 'project' && isProjectMember(resource.data.projectId));\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T08:08:00.789Z] Jun 30, 2025 8:08:00 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 8:08:00 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T08:08:01.178Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T08:08:01.181Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T08:30:11.088Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T08:30:11.088Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper function to check if a user is a member of a specific project.\n    // This is crucial for securing project-scoped data.\n    function isProjectMember(projectId) {\n      return get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids.has(request.auth.uid);\n    }\n\n    // USER PROFILES\n    // Users can update their own profile.\n    // Any authenticated user can read other user profiles to enable inviting members by email.\n    // This is safe as profiles only contain non-sensitive data like name and email.\n    match /users/{userId} {\n      allow read: if request.auth != null;\n      allow write: if request.auth.uid == userId;\n    }\n\n    // PROJECTS\n    // Defines who can read, create, or update project documents.\n    match /projects/{projectId} {\n      // READ: Only project members can read the project document.\n      allow read: if isProjectMember(projectId);\n      // CREATE: Any authenticated user can create a new project.\n      allow create: if request.auth != null;\n      // UPDATE: Only project members can update (e.g., add new members in the future).\n      allow update: if isProjectMember(projectId);\n      // DELETE: Deleting projects is disabled for data integrity.\n      allow delete: if false;\n    }\n\n    // DATA COLLECTIONS (Observations, Inspections, PTWs)\n    // A single, powerful rule for all data-related collections.\n    match /{collection}/{docId} where collection in ['observations', 'inspections', 'ptws'] {\n      // CREATE: A user can only create documents under their own user ID.\n      allow create: if request.auth.uid == request.resource.data.userId;\n\n      // READ: Determines who can view a specific document based on its scope.\n      allow read: if \n        // Anyone can read public documents.\n        resource.data.scope == 'public' ||\n        // Only the owner can read their private documents.\n        (resource.data.scope == 'private' && resource.data.userId == request.auth.uid) ||\n        // Only project members can read project-scoped documents.\n        (resource.data.scope == 'project' && isProjectMember(resource.data.projectId));\n\n      // UPDATE: Determines who can modify a document.\n      allow update: if \n        // The original creator can always update their own document.\n        request.auth.uid == resource.data.userId ||\n        // Any member of the associated project can also update the document (e.g., to take action).\n        (resource.data.scope == 'project' && isProjectMember(resource.data.projectId));\n      \n      // DELETE: Deleting documents is disabled to preserve historical records.\n      allow delete: if false;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T08:30:11.102Z] Jun 30, 2025 8:30:11 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 8:30:11 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T08:30:11.264Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T08:30:11.265Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":36,"column":11,"currentOffset":1478,"endOffset":1478},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":36,"column":33,"currentOffset":1500,"endOffset":1504},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":36,"column":33,"currentOffset":1500,"endOffset":1504},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":60,"column":1,"currentOffset":2723,"endOffset":2723},"description":"Unexpected '}'.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:36:11 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:36:33 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:36:33 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:60:1 - ERROR Unexpected '}'. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T08:38:56.630Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T08:38:56.631Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    function isProjectMember(projectId) {\n      return request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids;\n    }\n\n    match /users/{userId} {\n      allow read: if request.auth != null;\n      allow write: if request.auth.uid == userId;\n    }\n\n    match /projects/{projectId} {\n      allow read: if request.auth.uid in resource.data.memberUids;\n      allow create: if request.auth.uid == request.resource.data.ownerUid;\n      allow update: if request.auth.uid in resource.data.memberUids;\n    }\n\n    match /observations/{obsId} {\n      allow read: if resource.data.scope == 'public' || (request.auth != null && (resource.data.userId == request.auth.uid || isProjectMember(resource.data.projectId)));\n      allow create: if request.auth.uid == request.resource.data.userId;\n      allow update: if request.auth != null && (resource.data.userId == request.auth.uid || isProjectMember(resource.data.projectId));\n    }\n\n    match /inspections/{inspId} {\n      allow read: if resource.data.scope == 'public' || (request.auth != null && (resource.data.userId == request.auth.uid || isProjectMember(resource.data.projectId)));\n      allow create: if request.auth.uid == request.resource.data.userId;\n      allow update: if request.auth != null && (resource.data.userId == request.auth.uid || isProjectMember(resource.data.projectId));\n    }\n\n    match /ptws/{ptwId} {\n      allow read: if resource.data.scope == 'public' || (request.auth != null && (resource.data.userId == request.auth.uid || isProjectMember(resource.data.projectId)));\n      allow create: if request.auth.uid == request.resource.data.userId;\n      allow update: if request.auth != null && (resource.data.userId == request.auth.uid || isProjectMember(resource.data.projectId));\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T08:38:56.667Z] Jun 30, 2025 8:38:56 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 8:38:56 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T08:38:57.059Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T08:38:57.066Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T08:43:52.096Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T08:43:52.097Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // USERS COLLECTION\n    // Needed for inviting members to projects by email.\n    match /users/{userId} {\n      // Any authenticated user can query the collection to find others.\n      allow list: if request.auth != null;\n      // Users can get and update their own document.\n      allow get, update: if request.auth.uid == userId;\n    }\n\n    // PROJECTS COLLECTION\n    match /projects/{projectId} {\n      // Allow any authenticated user to create a project.\n      allow create: if request.auth != null;\n      // Allow a user to read a project if they are a member.\n      // This rule works with the client query: `where('memberUids', 'array-contains', user.uid)`\n      allow read: if request.auth != null && request.auth.uid in resource.data.memberUids;\n      // Only the project owner can update or delete it.\n      allow update, delete: if request.auth != null && request.auth.uid == resource.data.ownerUid;\n    }\n\n    // --- SHARED RULES FOR ITEMS (Observations, Inspections, PTWs) ---\n\n    // Helper function to check if the user is the owner of an item.\n    function isItemOwner() {\n      return request.auth.uid == resource.data.userId;\n    }\n\n    // Helper function to check if the user is a member of the item's project.\n    function isProjectMember() {\n      // Ensure the item is actually part of a project.\n      if (resource.data.scope != 'project' || resource.data.projectId == null) {\n        return false;\n      }\n      // Check if the user's UID is in the project's member list.\n      return request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.memberUids;\n    }\n\n    // OBSERVATIONS, INSPECTIONS, and PTWs\n    match /{collectionName}/{itemId}\n    where collectionName in ['observations', 'inspections', 'ptws'] {\n      \n      // CREATE: Any authenticated user can create an item.\n      allow create: if request.auth != null;\n      \n      // READ: Allow if the item is public, or if the user is the owner or a project member.\n      allow read: if request.auth != null && (resource.data.scope == 'public' || isItemOwner() || isProjectMember());\n      \n      // UPDATE: Allow if the user is the owner or a project member (e.g., for taking action or approving).\n      allow update: if request.auth != null && (isItemOwner() || isProjectMember());\n      \n      // DELETE: Only the owner of the item can delete it.\n      allow delete: if request.auth != null && isItemOwner();\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T08:43:52.113Z] Jun 30, 2025 8:43:52 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 8:43:52 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T08:43:52.213Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T08:43:52.214Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":35,"column":7,"currentOffset":1418,"endOffset":1419},"description":"Unexpected 'if'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":39,"column":7,"currentOffset":1595,"endOffset":1600},"description":"Unexpected 'return'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":39,"column":38,"currentOffset":1626,"endOffset":1635},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":39,"column":48,"currentOffset":1636,"endOffset":1636},"description":"Forward slash '/' found where identifier or binding expected.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":39,"column":49,"currentOffset":1637,"endOffset":1637},"description":"mismatched input '$' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":39,"column":60,"currentOffset":1648,"endOffset":1657},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":39,"column":79,"currentOffset":1667,"endOffset":1667},"description":"Forward slash '/' found where identifier or binding expected.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":39,"column":80,"currentOffset":1668,"endOffset":1668},"description":"mismatched input '$' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":43,"column":5,"currentOffset":1767,"endOffset":1771},"description":"Unexpected 'match'.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:35:7 - ERROR Unexpected 'if'. 
[warn] ⚠  firestore.rules:39:7 - ERROR Unexpected 'return'. 
[warn] ⚠  firestore.rules:39:38 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:39:48 - ERROR Forward slash '/' found where identifier or binding expected. 
[warn] ⚠  firestore.rules:39:49 - ERROR mismatched input '$' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:39:60 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:39:79 - ERROR Forward slash '/' found where identifier or binding expected. 
[warn] ⚠  firestore.rules:39:80 - ERROR mismatched input '$' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:43:5 - ERROR Unexpected 'match'. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T08:52:11.580Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T08:52:11.580Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Users can read other user profiles to find members for projects.\n    // They can only create and modify their own profile.\n    match /users/{userId} {\n      allow read: if request.auth != null;\n      allow create, update: if request.auth.uid == userId;\n      allow delete: if false;\n    }\n\n    // Projects can be created by an authenticated user, but the owner must be the creator.\n    // Only members can read the project, and only the owner can update/delete it.\n    match /projects/{projectId} {\n      allow read: if request.auth.uid in resource.data.memberUids;\n      allow create: if request.auth.uid == request.resource.data.ownerUid && request.auth.uid in request.resource.data.memberUids;\n      allow update, delete: if request.auth.uid == resource.data.ownerUid;\n    }\n\n    // Observations, Inspections, and PTWs\n    match /{collectionName}/{docId} where collectionName in ['observations', 'inspections', 'ptws'] {\n      \n      function isOwner() {\n        return request.auth.uid == resource.data.userId;\n      }\n      \n      function isPublic() {\n        return resource.data.scope == 'public';\n      }\n      \n      function isProjectMember() {\n        // Check if the document belongs to a project\n        let projectId = resource.data.get('projectId', null);\n        \n        // If there's no project ID, this rule doesn't apply\n        if (projectId == null) {\n          return false;\n        }\n\n        // Check if the user is a member of that project by checking if their UID is in the memberUids array.\n        return request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids;\n      }\n\n      // Allow read if the doc is public, or if the user is authenticated and is the owner OR a project member\n      allow read: if isPublic() || (request.auth != null && (isOwner() || isProjectMember()));\n      \n      // Allow create only if the userId on the new document matches the creator's ID\n      allow create: if request.auth.uid == request.resource.data.userId;\n\n      // Allow update only by the original creator\n      allow update: if isOwner();\n\n      allow delete: if false;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T08:52:11.596Z] Jun 30, 2025 8:52:11 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 8:52:11 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T08:52:11.718Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T08:52:11.720Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":23,"column":11,"currentOffset":930,"endOffset":930},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":23,"column":37,"currentOffset":956,"endOffset":960},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":23,"column":37,"currentOffset":956,"endOffset":960},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":38,"column":9,"currentOffset":1448,"endOffset":1449},"description":"Unexpected 'if'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":43,"column":9,"currentOffset":1626,"endOffset":1631},"description":"Unexpected 'return'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":43,"column":40,"currentOffset":1657,"endOffset":1666},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":43,"column":50,"currentOffset":1667,"endOffset":1667},"description":"Forward slash '/' found where identifier or binding expected.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":43,"column":51,"currentOffset":1668,"endOffset":1668},"description":"mismatched input '$' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":43,"column":62,"currentOffset":1679,"endOffset":1688},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":43,"column":81,"currentOffset":1698,"endOffset":1698},"description":"Forward slash '/' found where identifier or binding expected.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":43,"column":82,"currentOffset":1699,"endOffset":1699},"description":"mismatched input '$' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":47,"column":7,"currentOffset":1856,"endOffset":1860},"description":"Unexpected 'allow'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":57,"column":3,"currentOffset":2236,"endOffset":2236},"description":"Unexpected '}'.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:23:11 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:23:37 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:23:37 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:38:9 - ERROR Unexpected 'if'. 
[warn] ⚠  firestore.rules:43:9 - ERROR Unexpected 'return'. 
[warn] ⚠  firestore.rules:43:40 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:43:50 - ERROR Forward slash '/' found where identifier or binding expected. 
[warn] ⚠  firestore.rules:43:51 - ERROR mismatched input '$' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:43:62 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:43:81 - ERROR Forward slash '/' found where identifier or binding expected. 
[warn] ⚠  firestore.rules:43:82 - ERROR mismatched input '$' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:47:7 - ERROR Unexpected 'allow'. 
[warn] ⚠  firestore.rules:57:3 - ERROR Unexpected '}'. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T08:57:51.885Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T08:57:51.885Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // =================================\n    // Helper Functions\n    // =================================\n    function isOwner(projectDoc) {\n      return request.auth.uid == projectDoc.data.ownerUid;\n    }\n\n    function isProjectMember(projectId) {\n      // Safely access project data and check if the user's UID is in the memberUids array.\n      // This function is critical for securing access to project-scoped data.\n      let projectData = get(/databases/$(database)/documents/projects/$(projectId)).data;\n      return request.auth.uid in projectData.memberUids;\n    }\n\n\n    // =================================\n    // Collection: users\n    // =================================\n    match /users/{userId} {\n      // ANY authenticated user can query the users collection.\n      // THIS IS THE CRITICAL FIX for the \"invite by email\" feature.\n      // The server action needs this permission to find UIDs from emails.\n      allow list: if request.auth != null;\n\n      // A user can ONLY get their own profile document.\n      allow get: if request.auth.uid == userId;\n      \n      // A user can ONLY update their own profile document.\n      allow update: if request.auth.uid == userId;\n\n      // No one can create or delete users from the client.\n      allow create, delete: if false;\n    }\n\n\n    // =================================\n    // Collection: projects\n    // =================================\n    match /projects/{projectId} {\n      // A user can read a project's details ONLY if they are a member.\n      allow read: if request.auth != null && isProjectMember(projectId);\n      \n      // A user can create a project if they are authenticated and are the designated owner.\n      allow create: if request.auth != null && request.resource.data.ownerUid == request.auth.uid;\n      \n      // Only the project owner can update (e.g., add members) or delete the project.\n      allow update, delete: if request.auth != null && isOwner(resource);\n    }\n    \n\n    // =================================\n    // Collections: observations, inspections, ptws\n    // =================================\n    match /{collection}/{docId} where collection in ['observations', 'inspections', 'ptws'] {\n      // This rule applies to all data collections.\n\n      // Allow read access if the document is public, or if the user is the author,\n      // or if the user is a member of the project the document belongs to.\n      // 'read' covers both 'get' and 'list' operations.\n      allow read: if resource.data.scope == 'public' || \n                     (request.auth != null && (\n                       resource.data.userId == request.auth.uid ||\n                       (resource.data.projectId != null && isProjectMember(resource.data.projectId))\n                     ));\n      \n      // Allow a user to create a document if they are the author.\n      allow create: if request.auth.uid == request.resource.data.userId;\n\n      // Allow a user to update a document if they are the author OR a project member.\n      // This is essential for the \"Take Action\" feature.\n      allow update: if request.auth != null && (\n                      resource.data.userId == request.auth.uid ||\n                      (resource.data.projectId != null && isProjectMember(resource.data.projectId))\n                    );\n\n      // Only the document's author can delete it.\n      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T08:57:51.907Z] Jun 30, 2025 8:57:51 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 8:57:51 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T08:57:52.029Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T08:57:52.030Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":59,"column":11,"currentOffset":2194,"endOffset":2194},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":59,"column":33,"currentOffset":2216,"endOffset":2220},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":59,"column":33,"currentOffset":2216,"endOffset":2220},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":85,"column":1,"currentOffset":3528,"endOffset":3528},"description":"Unexpected '}'.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:59:11 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:59:33 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:59:33 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:85:1 - ERROR Unexpected '}'. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T09:04:02.397Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T09:04:02.405Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper function to check if a user is authenticated\n    function isAuthenticated() {\n      return request.auth != null;\n    }\n\n    // Helper function to check if a user is the owner of a document\n    function isOwner(userId) {\n      return request.auth.uid == userId;\n    }\n\n    // Helper function to check if a user is a member of a specific project\n    function isProjectMember(projectId) {\n      return isAuthenticated() && get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids.hasAny([request.auth.uid]);\n    }\n\n    // =====================================================================\n    // Users Collection\n    // =====================================================================\n    match /users/{userId} {\n      // Anyone authenticated can read any user's profile (needed for inviting to projects by email)\n      allow read: if isAuthenticated();\n      // A user can only create or update their own profile\n      allow write: if isOwner(userId);\n    }\n\n    // =====================================================================\n    // Projects Collection\n    // =====================================================================\n    match /projects/{projectId} {\n      // Only project members can read project details\n      allow read: if isProjectMember(projectId);\n\n      // An authenticated user can create a project if their UID is in the initial member list\n      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;\n\n      // Only the project owner can update a project (e.g., change name, add/remove members)\n      allow update: if isOwner(resource.data.ownerUid);\n\n      // Deleting projects is disabled for safety\n      allow delete: if false;\n    }\n\n    // =====================================================================\n    // Data Collections (Observations, Inspections, PTWs)\n    // =====================================================================\n    function canReadItem(item) {\n      return item.scope == 'public' || isOwner(item.userId) || (item.projectId != null && isProjectMember(item.projectId));\n    }\n    \n    function canWriteItem(item) {\n        return isOwner(item.userId);\n    }\n\n    function canUpdateItem(item) {\n        return isOwner(item.userId) || (item.projectId != null && isProjectMember(item.projectId));\n    }\n\n    match /observations/{obsId} {\n      allow read: if canReadItem(resource.data);\n      allow create: if canWriteItem(request.resource.data);\n      allow update: if canUpdateItem(resource.data);\n      allow delete: if isOwner(resource.data.userId);\n    }\n\n    match /inspections/{inspId} {\n      allow read: if canReadItem(resource.data);\n      allow create: if canWriteItem(request.resource.data);\n      allow update: if canUpdateItem(resource.data);\n      allow delete: if isOwner(resource.data.userId);\n    }\n\n    match /ptws/{ptwId} {\n      allow read: if canReadItem(resource.data);\n      allow create: if canWriteItem(request.resource.data);\n      allow update: if canUpdateItem(resource.data);\n      allow delete: if isOwner(resource.data.userId);\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T09:04:02.419Z] Jun 30, 2025 9:04:02 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 9:04:02 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T09:04:02.816Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T09:04:02.816Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T09:24:49.108Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T09:24:49.108Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    \n    function isSignedIn() {\n      return request.auth != null;\n    }\n\n    // Users: Can read any profile (for inviting), but only write to their own.\n    match /users/{userId} {\n      allow read: if isSignedIn();\n      allow write: if isSignedIn() && request.auth.uid == userId;\n    }\n\n    // Projects: \n    // - To read/update a project, you must be a member. This rule works for both\n    //   single-document gets and collection queries using \"array-contains\".\n    // - To create a project, you must be the owner specified in the new document.\n    match /projects/{projectId} {\n      allow create: if isSignedIn() && request.resource.data.ownerUid == request.auth.uid;\n      allow read, update: if isSignedIn() && request.auth.uid in resource.data.memberUids;\n      allow delete: if isSignedIn() && resource.data.ownerUid == request.auth.uid;\n    }\n    \n    // Generic rule for data collections (observations, inspections, ptw)\n    function canAccess(item) {\n      let isOwner = isSignedIn() && item.userId == request.auth.uid;\n      let isPublic = item.scope == 'public';\n      // projectId can be null, so check for it before trying to access it.\n      let isProjectScope = item.projectId != null && (request.auth.uid in get(/databases/$(database)/documents/projects/$(item.projectId)).data.memberUids);\n      \n      return isOwner || isPublic || isProjectScope;\n    }\n    \n    match /observations/{observationId} {\n      allow create: if canAccess(request.resource.data);\n      allow read, write: if canAccess(resource.data);\n    }\n    \n    match /inspections/{inspectionId} {\n      allow create: if canAccess(request.resource.data);\n      allow read, write: if canAccess(resource.data);\n    }\n    \n    match /ptws/{ptwId} {\n      allow create: if canAccess(request.resource.data);\n      allow read, write: if canAccess(resource.data);\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T09:24:49.149Z] Jun 30, 2025 9:24:49 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 9:24:49 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T09:24:49.758Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T09:24:49.765Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T09:31:58.326Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T09:31:58.326Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper Functions\n    function isAuthenticated() {\n      return request.auth != null;\n    }\n\n    function isOwner(userId) {\n      return request.auth.uid == userId;\n    }\n\t\t\n    function isProjectMember(projectId) {\n      return isAuthenticated() && get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids.hasAny([request.auth.uid]);\n    }\n\n    // Rules for 'users' collection\n    match /users/{userId} {\n      // Anyone authenticated can see a user's profile (for display names etc.)\n      allow get: if isAuthenticated();\n      // Only the user themselves can create or update their own profile\n      allow write: if isOwner(userId);\n    }\n\n    // Rules for 'projects' collection\n    match /projects/{projectId} {\n      // Anyone authenticated can create a new project document\n      allow create: if isAuthenticated() && isOwner(request.resource.data.ownerUid);\n      // Only members of the project can read its details\n      allow get, list: if isProjectMember(projectId);\n      // Only the owner can update a project (e.g., to add members in the future)\n      allow update: if isOwner(get(/databases/$(database)/documents/projects/$(projectId)).data.ownerUid);\n      // Nobody can delete projects from the client for safety\n      allow delete: if false;\n    }\n\n    // Generic rules for data collections (observations, inspections, ptws)\n    match /{collectionName}/{docId} where collectionName in ['observations', 'inspections', 'ptws'] {\n      \n      function canRead() {\n        // Allow read if:\n        // 1. The document is public\n        return resource.data.scope == 'public'\n        // 2. The user is authenticated and is the owner\n        || (isAuthenticated() && isOwner(resource.data.userId))\n        // 3. The user is a member of the linked project\n        || (resource.data.projectId != null && isProjectMember(resource.data.projectId));\n      }\n\n      function canWrite() {\n        // Allow write if:\n        // 1. Creating a new document and is authenticated\n        return isAuthenticated() && isOwner(request.resource.data.userId);\n      }\n      \n      function canUpdate() {\n        // Allow update if:\n        // 1. Authenticated and is owner\n        return isAuthenticated() && isOwner(resource.data.userId)\n        // 2. Or is a member of the project it belongs to\n        || (resource.data.projectId != null && isProjectMember(resource.data.projectId));\n      }\n\n      allow get, list: if canRead();\n      allow create: if canWrite();\n      allow update: if canUpdate();\n      // Nobody can delete for data integrity\n      allow delete: if false;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T09:31:58.357Z] Jun 30, 2025 9:31:58 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 9:31:58 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T09:31:58.686Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T09:31:58.689Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":41,"column":11,"currentOffset":1470,"endOffset":1470},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":41,"column":37,"currentOffset":1496,"endOffset":1500},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":41,"column":37,"currentOffset":1496,"endOffset":1500},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":74,"column":1,"currentOffset":2702,"endOffset":2702},"description":"Unexpected '}'.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:41:11 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:41:37 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:41:37 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:74:1 - ERROR Unexpected '}'. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T09:42:06.298Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T09:42:06.298Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper function to check if a user is a member of a specific project.\n    // It verifies that the user's UID is present in the project's memberUids array.\n    function isProjectMember(projectId) {\n      return get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids.has(request.auth.uid);\n    }\n    \n    //----------------------------------------------------------------------\n    //  USERS Collection\n    //----------------------------------------------------------------------\n    match /users/{userId} {\n      // ANY authenticated user can READ any user's profile.\n      // This is necessary to allow searching for users by email to invite them to projects.\n      // The data in user profiles (name, email, position) is not considered highly sensitive.\n      allow read: if request.auth != null;\n\n      // ONLY the user themselves can CREATE or UPDATE their own profile.\n      allow write: if request.auth.uid == userId;\n    }\n\n    //----------------------------------------------------------------------\n    //  PROJECTS Collection\n    //----------------------------------------------------------------------\n    match /projects/{projectId} {\n      // READ access is granted if the user is a member of the project.\n      allow read: if request.auth != null && isProjectMember(projectId);\n      \n      // CREATE access is granted if the requesting user is the owner of the new project document.\n      // This prevents users from creating projects on behalf of others.\n      allow create: if request.auth != null && request.auth.uid == request.resource.data.ownerUid;\n\n      // UPDATE access is granted only to the project owner.\n      // (For future features like adding/removing members).\n      allow update: if request.auth != null && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerUid == request.auth.uid;\n\n      // DELETE access is disabled for now to prevent accidental data loss.\n      allow delete: if false;\n    }\n    \n    //----------------------------------------------------------------------\n    //  DATA Collections (Observations, Inspections, PTWs)\n    //  Generic rules apply to all three data types.\n    //----------------------------------------------------------------------\n    match /{collection}/{docId} where collection in ['observations', 'inspections', 'ptws'] {\n    \n      // READ access logic:\n      // A user can read a document if:\n      // 1. The document is marked as 'public'.\n      // 2. The user is a member of the project the document belongs to.\n      // 3. The document is the user's own private document (scope is 'private' or 'project' and userId matches).\n      allow read: if request.auth != null && \n                   (resource.data.scope == 'public' || \n                    (resource.data.projectId != null && isProjectMember(resource.data.projectId)) ||\n                    (resource.data.scope == 'private' && resource.data.userId == request.auth.uid));\n\n      // CREATE access is granted if the user creating the document is the same user\n      // assigned to the 'userId' field in the document.\n      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;\n\n      // UPDATE access logic:\n      // A user can update a document if:\n      // 1. They are a member of the project the document belongs to.\n      // 2. It is their own private document.\n      allow update: if request.auth != null &&\n                     ((resource.data.projectId != null && isProjectMember(resource.data.projectId)) ||\n                      (resource.data.scope == 'private' && resource.data.userId == request.auth.uid));\n                      \n      // DELETE access is disabled for data integrity.\n      allow delete: if false;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T09:42:06.328Z] Jun 30, 2025 9:42:06 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 9:42:06 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T09:42:06.504Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T09:42:06.504Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":48,"column":11,"currentOffset":2347,"endOffset":2347},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":48,"column":33,"currentOffset":2369,"endOffset":2373},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":48,"column":33,"currentOffset":2369,"endOffset":2373},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":76,"column":1,"currentOffset":3843,"endOffset":3843},"description":"Unexpected '}'.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:48:11 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:48:33 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:48:33 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:76:1 - ERROR Unexpected '}'. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T09:44:24.202Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T09:44:24.202Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper function to check if a user is a member of a specific project.\n    // It verifies that the user's UID is present in the project's memberUids array.\n    function isProjectMember(projectId) {\n      return get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids.has(request.auth.uid);\n    }\n    \n    //----------------------------------------------------------------------\n    //  USERS Collection\n    //----------------------------------------------------------------------\n    match /users/{userId} {\n      // ANY authenticated user can READ any user's profile.\n      // This is necessary to allow searching for users by email to invite them to projects.\n      // The data in user profiles (name, email, position) is not considered highly sensitive.\n      allow read: if request.auth != null;\n\n      // ONLY the user themselves can CREATE or UPDATE their own profile.\n      allow write: if request.auth.uid == userId;\n    }\n\n    //----------------------------------------------------------------------\n    //  PROJECTS Collection\n    //----------------------------------------------------------------------\n    match /projects/{projectId} {\n      // READ access is granted if the user is a member of the project.\n      allow read: if request.auth != null && isProjectMember(projectId);\n      \n      // CREATE access is granted if the requesting user is the owner of the new project document.\n      // This prevents users from creating projects on behalf of others.\n      allow create: if request.auth != null && request.auth.uid == request.resource.data.ownerUid;\n\n      // UPDATE access is granted only to the project owner.\n      // (For future features like adding/removing members).\n      allow update: if request.auth != null && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerUid == request.auth.uid;\n\n      // DELETE access is disabled for now to prevent accidental data loss.\n      allow delete: if false;\n    }\n    \n    //----------------------------------------------------------------------\n    //  DATA Collections (Observations, Inspections, PTWs)\n    //  Generic rules apply to all three data types.\n    //----------------------------------------------------------------------\n    match /{collection}/{docId} where collection in ['observations', 'inspections', 'ptws'] {\n    \n      // READ access logic:\n      // A user can read a document if:\n      // 1. The document is marked as 'public'.\n      // 2. The user is a member of the project the document belongs to.\n      // 3. The document is the user's own private document (scope is 'private' or 'project' and userId matches).\n      allow read: if request.auth != null && \n                   (resource.data.scope == 'public' || \n                    (resource.data.projectId != null && isProjectMember(resource.data.projectId)) ||\n                    (resource.data.scope == 'private' && resource.data.userId == request.auth.uid));\n\n      // CREATE access is granted if the user creating the document is the same user\n      // assigned to the 'userId' field in the document.\n      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;\n\n      // UPDATE access logic:\n      // A user can update a document if:\n      // 1. They are a member of the project the document belongs to.\n      // 2. It is their own private document.\n      allow update: if request.auth != null &&\n                     ((resource.data.projectId != null && isProjectMember(resource.data.projectId)) ||\n                      (resource.data.scope == 'private' && resource.data.userId == request.auth.uid));\n                      \n      // DELETE access is disabled for data integrity.\n      allow delete: if false;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T09:44:24.227Z] Jun 30, 2025 9:44:24 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 9:44:24 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T09:44:24.396Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T09:44:24.397Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":48,"column":11,"currentOffset":2347,"endOffset":2347},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":48,"column":33,"currentOffset":2369,"endOffset":2373},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":48,"column":33,"currentOffset":2369,"endOffset":2373},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":76,"column":1,"currentOffset":3843,"endOffset":3843},"description":"Unexpected '}'.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:48:11 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:48:33 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:48:33 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:76:1 - ERROR Unexpected '}'. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T11:10:58.984Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T11:10:58.985Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    \n    // --- Helper Functions ---\n    function isSignedIn() {\n      return request.auth != null;\n    }\n\n    function isUser(uid) {\n      return isSignedIn() && request.auth.uid == uid;\n    }\n\n    // Correctly checks if the requesting user is a member of a given project.\n    // This was the source of a critical bug.\n    function isProjectMember(projectId) {\n      // The `get()` call reads the project document.\n      // We check if the user's UID is present in the `memberUids` array using the `in` operator.\n      return isSignedIn() && projectId != null && request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids;\n    }\n\n    // --- Collection Rules ---\n\n    // Users: Can only read/update their own profile. Authenticated users can list them for invites.\n    match /users/{userId} {\n      allow read, update: if isUser(userId);\n      // This allows the createProject server action to find users by email.\n      allow list: if isSignedIn(); \n    }\n\n    // Projects: Members can read/update. Only the owner can create.\n    match /projects/{projectId} {\n      allow read, update: if isProjectMember(projectId);\n      allow create: if isSignedIn() && \n                     request.resource.data.ownerUid == request.auth.uid && \n                     request.auth.uid in request.resource.data.memberUids;\n    }\n\n    // Generic Rules for all item collections (observations, inspections, ptws)\n    match /{itemCollection}/{itemId} {\n       // READ: An item can be read if:\n       // 1. It's public.\n       // 2. It's private AND you are the owner.\n       // 3. It's a project item AND you are a member of that project.\n       allow read: if resource.data.scope == 'public' ||\n                      (resource.data.scope == 'private' && isUser(resource.data.userId)) || \n                      (resource.data.scope == 'project' && isProjectMember(resource.data.projectId));\n\n       // CREATE: An item can be created if you are signed in and you are the author.\n       allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;\n\n       // UPDATE: An item can be updated if you are the original author OR a member of its project.\n       allow update: if isUser(resource.data.userId) || isProjectMember(resource.data.projectId);\n       \n       // DELETE: Only the creator can delete their own reports.\n       allow delete: if isUser(resource.data.userId);\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T11:10:59.037Z] Jun 30, 2025 11:10:59 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 11:10:59 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T11:10:59.140Z] Jun 30, 2025 11:10:59 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 11:10:59 AM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected HTTP/2 connection.\n"}}
[debug] [2025-06-30T11:10:59.470Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T11:10:59.470Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[debug] [2025-06-30T13:04:05.666Z] ----------------------------------------------------------------------
[debug] [2025-06-30T13:04:05.671Z] Command:       /nix/store/rbdrkcs5kkwpalxcd7c6bnm33lk2955n-nodejs-20.19.0/bin/node /nix/store/fprgfkwna33crhc86jqbf5878piivvgw-firebase-tools-14.7.0/lib/node_modules/firebase-tools/lib/bin/firebase.js emulators:start --project=demo-app --only=auth,firestore
[debug] [2025-06-30T13:04:05.672Z] CLI Version:   14.7.0
[debug] [2025-06-30T13:04:05.673Z] Platform:      linux
[debug] [2025-06-30T13:04:05.673Z] Node Version:  v20.19.0
[debug] [2025-06-30T13:04:05.673Z] Time:          Mon Jun 30 2025 13:04:05 GMT+0000 (Coordinated Universal Time)
[debug] [2025-06-30T13:04:05.674Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-06-30T13:04:05.679Z] >>> [apiv2][query] GET https://firebase-public.firebaseio.com/cli.json [none]
[debug] [2025-06-30T13:04:07.507Z] <<< [apiv2][status] GET https://firebase-public.firebaseio.com/cli.json 200
[debug] [2025-06-30T13:04:07.508Z] <<< [apiv2][body] GET https://firebase-public.firebaseio.com/cli.json {"cloudBuildErrorAfter":1594252800000,"cloudBuildWarnAfter":1590019200000,"defaultNode10After":1594252800000,"minVersion":"3.0.5","node8DeploysDisabledAfter":1613390400000,"node8RuntimeDisabledAfter":1615809600000,"node8WarnAfter":1600128000000}
[debug] [2025-06-30T13:04:08.021Z] openjdk version "21.0.5" 2024-10-15
OpenJDK Runtime Environment (build 21.0.5+1-nixos)
OpenJDK 64-Bit Server VM (build 21.0.5+1-nixos, mixed mode, sharing)

[debug] [2025-06-30T13:04:08.064Z] Parsed Java major version: 21
[info] i  emulators: Starting emulators: firestore {"metadata":{"emulator":{"name":"hub"},"message":"Starting emulators: firestore"}}
[info] i  emulators: Detected demo project ID "demo-app", emulated services will use a demo configuration and attempts to access non-emulated services for this project will fail. {"metadata":{"emulator":{"name":"hub"},"message":"Detected demo project ID \"demo-app\", emulated services will use a demo configuration and attempts to access non-emulated services for this project will fail."}}
[warn] ⚠  auth: Not starting the auth emulator, make sure you have run firebase init. {"metadata":{"emulator":{"name":"auth"},"message":"Not starting the auth emulator, make sure you have run firebase init."}}
[warn] ⚠  hub: Error when trying to check port 4400 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4400 {"metadata":{"emulator":{"name":"hub"},"message":"Error when trying to check port 4400 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4400"}}
[warn] ⚠  hub: Port 4400 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"hub"},"message":"Port 4400 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  hub: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"hub"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  ui: Error when trying to check port 4000 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4000 {"metadata":{"emulator":{"name":"ui"},"message":"Error when trying to check port 4000 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4000"}}
[warn] ⚠  ui: Port 4000 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"ui"},"message":"Port 4000 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  ui: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"ui"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  logging: Error when trying to check port 4500 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4500 {"metadata":{"emulator":{"name":"logging"},"message":"Error when trying to check port 4500 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:4500"}}
[warn] ⚠  logging: Port 4500 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"logging"},"message":"Port 4500 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  logging: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"logging"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  firestore: Error when trying to check port 8080 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:8080 {"metadata":{"emulator":{"name":"firestore"},"message":"Error when trying to check port 8080 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:8080"}}
[warn] ⚠  firestore: Port 8080 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"firestore"},"message":"Port 8080 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  firestore: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"firestore"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[warn] ⚠  firestore.websocket: Error when trying to check port 9150 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:9150 {"metadata":{"emulator":{"name":"firestore"},"message":"Error when trying to check port 9150 on ::1: Error: listen EADDRNOTAVAIL: address not available ::1:9150"}}
[warn] ⚠  firestore: Port 9150 is available on 127.0.0.1 but not ::1. This may cause issues with some clients. {"metadata":{"emulator":{"name":"firestore"},"message":"Port 9150 is available on 127.0.0.1 but not ::1. This may cause issues with some clients."}}
[warn] ⚠  firestore: If you encounter connectivity issues, consider switching to a different port or explicitly specifying "host": "<ip address>" instead of hostname in firebase.json {"metadata":{"emulator":{"name":"firestore"},"message":"If you encounter connectivity issues, consider switching to a different port or explicitly specifying \"host\": \"<ip address>\" instead of hostname in firebase.json"}}
[debug] [2025-06-30T13:04:08.084Z] assigned listening specs for emulators {"user":{"hub":[{"address":"127.0.0.1","family":"IPv4","port":4400}],"ui":[{"address":"127.0.0.1","family":"IPv4","port":4000}],"logging":[{"address":"127.0.0.1","family":"IPv4","port":4500}],"firestore":[{"address":"127.0.0.1","family":"IPv4","port":8080}],"firestore.websocket":[{"address":"127.0.0.1","family":"IPv4","port":9150}]},"metadata":{"message":"assigned listening specs for emulators"}}
[debug] [2025-06-30T13:04:08.093Z] [hub] writing locator at /tmp/hub-demo-app.json
[debug] [2025-06-30T13:04:08.113Z] Ignoring unsupported arg: auto_download {"metadata":{"emulator":{"name":"firestore"},"message":"Ignoring unsupported arg: auto_download"}}
[debug] [2025-06-30T13:04:08.114Z] Ignoring unsupported arg: single_project_mode_error {"metadata":{"emulator":{"name":"firestore"},"message":"Ignoring unsupported arg: single_project_mode_error"}}
[debug] [2025-06-30T13:04:08.114Z] Starting Firestore Emulator with command {"binary":"java","args":["-Dgoogle.cloud_firestore.debug_log_level=FINE","-Duser.language=en","-jar","/nix/store/w60wgw0k95kiq4yl5f561xhydyg07gf7-emulators/cloud-firestore-emulator-v1.19.8.jar","--host","127.0.0.1","--port",8080,"--websocket_port",9150,"--project_id","demo-app","--rules","/home/user/studio/firestore.rules","--single_project_mode",true],"optionalArgs":["port","webchannel_port","host","rules","websocket_port","functions_emulator","seed_from_export","project_id","single_project_mode"],"joinArgs":false,"shell":false,"port":8080} {"metadata":{"emulator":{"name":"firestore"},"message":"Starting Firestore Emulator with command {\"binary\":\"java\",\"args\":[\"-Dgoogle.cloud_firestore.debug_log_level=FINE\",\"-Duser.language=en\",\"-jar\",\"/nix/store/w60wgw0k95kiq4yl5f561xhydyg07gf7-emulators/cloud-firestore-emulator-v1.19.8.jar\",\"--host\",\"127.0.0.1\",\"--port\",8080,\"--websocket_port\",9150,\"--project_id\",\"demo-app\",\"--rules\",\"/home/user/studio/firestore.rules\",\"--single_project_mode\",true],\"optionalArgs\":[\"port\",\"webchannel_port\",\"host\",\"rules\",\"websocket_port\",\"functions_emulator\",\"seed_from_export\",\"project_id\",\"single_project_mode\"],\"joinArgs\":false,\"shell\":false,\"port\":8080}"}}
[info] i  firestore: Firestore Emulator logging to firestore-debug.log {"metadata":{"emulator":{"name":"firestore"},"message":"Firestore Emulator logging to firestore-debug.log"}}
[debug] [2025-06-30T13:04:12.382Z] Jun 30, 2025 1:04:12 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketServer start
INFO: Started WebSocket server on ws://127.0.0.1:9150
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 1:04:12 PM com.google.cloud.datastore.emulator.firestore.websocket.WebSocketServer start\nINFO: Started WebSocket server on ws://127.0.0.1:9150\n"}}
[debug] [2025-06-30T13:04:12.498Z] API endpoint: http:// {"metadata":{"emulator":{"name":"firestore"},"message":"API endpoint: http://"}}
[debug] [2025-06-30T13:04:12.500Z] 127.0.0.1:8080
If you are using a library that supports the FIRESTORE_EMULATOR_HOST environment variable, run:

   export FIRESTORE_EMULATOR_HOST=127.0.0.1:8080

If you are running a Firestore in Datastore Mode project, run:

   export DATASTORE_EMULATOR_HOST=127.0.0.1:8080

Note: Support for Datastore Mode is in preview. If you encounter any bugs please file at https://github.com/firebase/firebase-tools/issues.
Dev App Server is now running.

 {"metadata":{"emulator":{"name":"firestore"},"message":"127.0.0.1:8080\nIf you are using a library that supports the FIRESTORE_EMULATOR_HOST environment variable, run:\n\n   export FIRESTORE_EMULATOR_HOST=127.0.0.1:8080\n\nIf you are running a Firestore in Datastore Mode project, run:\n\n   export DATASTORE_EMULATOR_HOST=127.0.0.1:8080\n\nNote: Support for Datastore Mode is in preview. If you encounter any bugs please file at https://github.com/firebase/firebase-tools/issues.\nDev App Server is now running.\n\n"}}
[info] ✔  firestore: Firestore Emulator UI websocket is running on 9150. {"metadata":{"emulator":{"name":"firestore"},"message":"Firestore Emulator UI websocket is running on 9150."}}
[debug] [2025-06-30T13:04:12.681Z] Could not find VSCode notification endpoint: FetchError: request to http://localhost:40001/vscode/notify failed, reason: connect ECONNREFUSED 127.0.0.1:40001. If you are not running the Firebase Data Connect VSCode extension, this is expected and not an issue.
[info] 
┌─────────────────────────────────────────────────────────────┐
│ ✔  All emulators ready! It is now safe to connect your app. │
│ i  View Emulator UI at http://127.0.0.1:4000/               │
└─────────────────────────────────────────────────────────────┘

┌───────────┬────────────────┬─────────────────────────────────┐
│ Emulator  │ Host:Port      │ View in Emulator UI             │
├───────────┼────────────────┼─────────────────────────────────┤
│ Firestore │ 127.0.0.1:8080 │ http://127.0.0.1:4000/firestore │
└───────────┴────────────────┴─────────────────────────────────┘
  Emulator Hub host: 127.0.0.1 port: 4400
  Other reserved ports: 4500, 9150

Issues? Report them at https://github.com/firebase/firebase-tools/issues and attach the *-debug.log files.
 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T13:04:34.575Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T13:04:34.575Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    \n    // --- Helper Functions ---\n    function isSignedIn() {\n      return request.auth != null;\n    }\n\n    function isUser(uid) {\n      return isSignedIn() && request.auth.uid == uid;\n    }\n\n    // Correctly checks if the requesting user is a member of a given project.\n    // This was the source of a critical bug.\n    function isProjectMember(projectId) {\n      // The `get()` call reads the project document.\n      // We check if the user's UID is present in the `memberUids` array using the `in` operator.\n      return isSignedIn() && projectId != null && request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids;\n    }\n\n    // --- Collection Rules ---\n\n    // Users: Can only read/update their own profile. Authenticated users can list them for invites.\n    match /users/{userId} {\n      allow read, update: if isUser(userId);\n      // This allows the createProject server action to find users by email.\n      allow list: if isSignedIn(); \n    }\n\n    // Projects: Members can read/update. Only the owner can create.\n    match /projects/{projectId} {\n      allow read, update: if isProjectMember(projectId);\n      allow create: if isSignedIn() && \n                     request.resource.data.ownerUid == request.auth.uid && \n                     request.auth.uid in request.resource.data.memberUids;\n    }\n\n    // Generic Rules for all item collections (observations, inspections, ptws)\n    match /{itemCollection}/{itemId} {\n       // READ: An item can be read if:\n       // 1. It's public.\n       // 2. It's private AND you are the owner.\n       // 3. It's a project item AND you are a member of that project.\n       allow read: if resource.data.scope == 'public' ||\n                      (resource.data.scope == 'private' && isUser(resource.data.userId)) || \n                      (resource.data.scope == 'project' && isProjectMember(resource.data.projectId));\n\n       // CREATE: An item can be created if you are signed in and you are the author.\n       allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;\n\n       // UPDATE: An item can be updated if you are the original author OR a member of its project.\n       allow update: if isUser(resource.data.userId) || isProjectMember(resource.data.projectId);\n       \n       // DELETE: Only the creator can delete their own reports.\n       allow delete: if isUser(resource.data.userId);\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T13:04:34.950Z] Jun 30, 2025 1:04:34 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 1:04:34 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T13:04:37.680Z] Jun 30, 2025 1:04:37 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 1:04:37 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected HTTP/2 connection.\n"}}
[debug] [2025-06-30T13:05:01.275Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T13:05:01.276Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T13:24:50.955Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T13:24:50.956Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    \n    // =================================\n    // Helper Functions\n    // =================================\n    function isSignedIn() {\n      return request.auth != null;\n    }\n\n    // Checks if the requesting user is a member of a specific project.\n    // Used for GET requests on single documents.\n    function isProjectMember(projectId) {\n      return isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids.hasAny([request.auth.uid]);\n    }\n\n    // =================================\n    // User Profiles\n    // =================================\n    match /users/{userId} {\n      // Any authenticated user can read user profiles (needed for inviting members).\n      allow read: if isSignedIn();\n      // A user can only create their own profile document.\n      allow create: if request.auth.uid == userId;\n      // A user can only update their own profile.\n      allow update: if request.auth.uid == userId;\n      allow delete: if false;\n    }\n    \n    // =================================\n    // Projects\n    // =================================\n    match /projects/{projectId} {\n      // Allow reading a project's details only if you are a member.\n      allow get: if isProjectMember(projectId);\n      \n      // Allow LISTING projects only if the query explicitly asks for projects\n      // where the current user is a member. This forces secure client queries.\n      allow list: if isSignedIn() && request.query.where.get('memberUids') != null && request.query.where.get('memberUids')[2][0] == request.auth.uid;\n      \n      // Allow creating a project if the requester is the owner and is in the members list.\n      allow create: if isSignedIn() &&\n                       request.auth.uid == request.resource.data.ownerUid &&\n                       request.auth.uid in request.resource.data.memberUids;\n                       \n      // Allow updating a project only if you are the owner (for future use).\n      allow update: if resource.data.ownerUid == request.auth.uid;\n      allow delete: if false;\n    }\n    \n    // =================================\n    // Generic Item Collections (Observations, Inspections, PTWs)\n    // =================================\n    match /{itemCollection}/{itemId} where itemCollection in ['observations', 'inspections', 'ptws'] {\n    \n      // Allow creating an item if you are the author.\n      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;\n      \n      // Allow reading a single item if it's public, you are the author, or you are a member of its project.\n      allow get: if (resource.data.scope == 'public') ||\n                    (resource.data.userId == request.auth.uid) ||\n                    (resource.data.scope == 'project' && isProjectMember(resource.data.projectId));\n                    \n      // Allow LISTING items only for specific, secure queries from the client.\n      allow list: if \n          // 1. Allow querying the public feed.\n          (request.query.where.get('scope') == 'public') ||\n          // 2. Allow a user to query for items they authored.\n          (isSignedIn() && request.query.where.get('userId') == request.auth.uid) ||\n          // 3. Allow a user to query for items within a specific project they are a member of.\n          (isSignedIn() && request.query.where.get('projectId') != null && isProjectMember(request.query.where.get('projectId')[2][0]));\n          \n      // Allow updates if you are the author or a member of the item's project.\n      allow update: if isSignedIn() && (request.auth.uid == resource.data.userId || (resource.data.scope == 'project' && isProjectMember(resource.data.projectId)));\n      allow delete: if false;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T13:24:50.985Z] Jun 30, 2025 1:24:50 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 1:24:50 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T13:24:51.554Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T13:24:51.554Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":56,"column":11,"currentOffset":2307,"endOffset":2307},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":56,"column":38,"currentOffset":2334,"endOffset":2338},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":56,"column":38,"currentOffset":2334,"endOffset":2338},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":80,"column":1,"currentOffset":3796,"endOffset":3796},"description":"Unexpected '}'.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:56:11 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:56:38 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:56:38 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:80:1 - ERROR Unexpected '}'. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T13:47:42.032Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T13:47:42.036Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n  \n    // Helper Functions\n    function isSignedIn() {\n      return request.auth != null;\n    }\n    \n    function isOwner(userId) {\n      return request.auth.uid == userId;\n    }\n    \n    // Checks if the requesting user is a member of a specific project.\n    function isProjectMember(projectId) {\n      // Use exists() for security and efficiency instead of get()\n      return isSignedIn() && exists(/databases/$(database)/documents/projects/$(projectId)) &&\n             get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids.hasAny([request.auth.uid]);\n    }\n    \n    // User Profiles\n    match /users/{userId} {\n      // Anyone signed in can read user profiles. Needed for inviting members to projects.\n      allow read: if isSignedIn();\n      // A user can only create or update their own profile.\n      allow create, update: if isOwner(userId);\n    }\n    \n    // Projects Collection\n    match /projects/{projectId} {\n      // A user can read a project's details only if they are a member.\n      allow get: if isProjectMember(projectId);\n      \n      // A user can list only the projects they are a member of.\n      allow list: if isSignedIn() && request.query.where.get('memberUids').get('array-contains').get(0) == request.auth.uid;\n      \n      // A user can create a project if they are signed in, listed as the owner, and included in the member list.\n      allow create: if isSignedIn() && request.resource.data.ownerUid == request.auth.uid && request.auth.uid in request.resource.data.memberUids;\n      \n      // Only the project owner can update a project (e.g., add members).\n      allow update: if isOwner(get(/databases/$(database)/documents/projects/$(projectId)).data.ownerUid);\n    }\n    \n    // Generic Data Rule for Observations, Inspections, PTWs\n    match /{collection}/{itemId} {\n    \n      // READ access control\n      // A user can read a document if:\n      // 1. It's public.\n      // 2. It's their own private document.\n      // 3. They are a member of the project it belongs to.\n      allow get: if (resource.data.scope == 'public') || \n                    (resource.data.scope == 'private' && isOwner(resource.data.userId)) || \n                    (resource.data.scope == 'project' && isProjectMember(resource.data.projectId));\n                    \n      // LIST (Query) access control\n      // A user can query a collection if the query targets:\n      // 1. Public documents.\n      // 2. Their own private documents (by userId and scope).\n      // 3. Documents from a specific project they are a member of.\n      allow list: if (request.query.where.get('scope') != null && request.query.where.get('scope').get('==') == 'public') ||\n                     (request.query.where.get('userId') != null && request.query.where.get('userId').get('==') == request.auth.uid) ||\n                     (request.query.where.get('projectId') != null && isProjectMember(request.query.where.get('projectId').get('==')));\n\n      // WRITE access control\n      // A user can create a document if they are signed in and are the owner of the new document.\n      allow create: if isSignedIn() && isOwner(request.resource.data.userId);\n      // A user can update a document only if they are its owner, or a member of the project for project-scoped items.\n      allow update: if isSignedIn() && (isOwner(resource.data.userId) || (resource.data.scope == 'project' && isProjectMember(resource.data.projectId)));\n      // A user can delete a document only if they are its owner.\n      allow delete: if isSignedIn() && isOwner(resource.data.userId);\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T13:47:42.054Z] Jun 30, 2025 1:47:42 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 1:47:42 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T13:47:42.985Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T13:47:42.986Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":36,"column":58,"currentOffset":1283,"endOffset":1285},"description":"Incorrect number of arguments supplied to function: get.","severity":"WARNING"},{"sourcePosition":{"fileName":"security.rules","line":36,"column":76,"currentOffset":1301,"endOffset":1303},"description":"Incorrect number of arguments supplied to function: get.","severity":"WARNING"},{"sourcePosition":{"fileName":"security.rules","line":36,"column":98,"currentOffset":1323,"endOffset":1325},"description":"Incorrect number of arguments supplied to function: get.","severity":"WARNING"},{"sourcePosition":{"fileName":"security.rules","line":62,"column":43,"currentOffset":2690,"endOffset":2692},"description":"Incorrect number of arguments supplied to function: get.","severity":"WARNING"},{"sourcePosition":{"fileName":"security.rules","line":62,"column":87,"currentOffset":2734,"endOffset":2736},"description":"Incorrect number of arguments supplied to function: get.","severity":"WARNING"},{"sourcePosition":{"fileName":"security.rules","line":62,"column":100,"currentOffset":2747,"endOffset":2749},"description":"Incorrect number of arguments supplied to function: get.","severity":"WARNING"},{"sourcePosition":{"fileName":"security.rules","line":63,"column":43,"currentOffset":2815,"endOffset":2817},"description":"Incorrect number of arguments supplied to function: get.","severity":"WARNING"},{"sourcePosition":{"fileName":"security.rules","line":63,"column":88,"currentOffset":2860,"endOffset":2862},"description":"Incorrect number of arguments supplied to function: get.","severity":"WARNING"},{"sourcePosition":{"fileName":"security.rules","line":63,"column":102,"currentOffset":2874,"endOffset":2876},"description":"Incorrect number of arguments supplied to function: get.","severity":"WARNING"},{"sourcePosition":{"fileName":"security.rules","line":64,"column":43,"currentOffset":2950,"endOffset":2952},"description":"Incorrect number of arguments supplied to function: get.","severity":"WARNING"},{"sourcePosition":{"fileName":"security.rules","line":64,"column":107,"currentOffset":3014,"endOffset":3016},"description":"Incorrect number of arguments supplied to function: get.","severity":"WARNING"},{"sourcePosition":{"fileName":"security.rules","line":64,"column":124,"currentOffset":3031,"endOffset":3033},"description":"Incorrect number of arguments supplied to function: get.","severity":"WARNING"}]}
[warn] ⚠  firestore.rules:36:58 - WARNING Incorrect number of arguments supplied to function: get. 
[warn] ⚠  firestore.rules:36:76 - WARNING Incorrect number of arguments supplied to function: get. 
[warn] ⚠  firestore.rules:36:98 - WARNING Incorrect number of arguments supplied to function: get. 
[warn] ⚠  firestore.rules:62:43 - WARNING Incorrect number of arguments supplied to function: get. 
[warn] ⚠  firestore.rules:62:87 - WARNING Incorrect number of arguments supplied to function: get. 
[warn] ⚠  firestore.rules:62:100 - WARNING Incorrect number of arguments supplied to function: get. 
[warn] ⚠  firestore.rules:63:43 - WARNING Incorrect number of arguments supplied to function: get. 
[warn] ⚠  firestore.rules:63:88 - WARNING Incorrect number of arguments supplied to function: get. 
[warn] ⚠  firestore.rules:63:102 - WARNING Incorrect number of arguments supplied to function: get. 
[warn] ⚠  firestore.rules:64:43 - WARNING Incorrect number of arguments supplied to function: get. 
[warn] ⚠  firestore.rules:64:107 - WARNING Incorrect number of arguments supplied to function: get. 
[warn] ⚠  firestore.rules:64:124 - WARNING Incorrect number of arguments supplied to function: get. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T14:00:25.719Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T14:00:25.721Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // =====================================================================\n    // Helper Functions\n    // =====================================================================\n    function isSignedIn() {\n      return request.auth != null;\n    }\n\n    function isOwner(userId) {\n      return request.auth.uid == userId;\n    }\n    \n    // Checks if a user is a member of a specific project.\n    // This is used for GET requests on single documents.\n    function isProjectMember(projectId) {\n      let projectDoc = get(/databases/$(database)/documents/projects/$(projectId));\n      return isSignedIn() && exists(/databases/$(database)/documents/projects/$(projectId)) \n             && request.auth.uid in projectDoc.data.memberUids;\n    }\n\n    // =====================================================================\n    // User Profiles\n    // =====================================================================\n    match /users/{userId} {\n      // Anyone signed in can view a user's profile (needed to get emails for invites)\n      allow get: if isSignedIn();\n      // Only the user themselves can create or update their own profile\n      allow write: if isOwner(userId);\n      // Allow authenticated users to list users (e.g., for invites)\n      allow list: if isSignedIn();\n    }\n\n    // =====================================================================\n    // Projects\n    // =====================================================================\n    match /projects/{projectId} {\n      // Only project members can read project details.\n      allow get: if isProjectMember(projectId);\n      // Anyone can create a project, as long as they list themselves as owner and member.\n      allow create: if isSignedIn() \n                    && isOwner(request.resource.data.ownerUid)\n                    && request.auth.uid in request.resource.data.memberUids;\n      // Future-proofing: Only owner can update/delete\n      allow update, delete: if isOwner(resource.data.ownerUid);\n      // Allow project members to list projects they are a part of.\n      allow list: if isSignedIn() && request.auth.uid in resource.data.memberUids;\n    }\n\n    // =====================================================================\n    // Data Collections (Observations, Inspections, PTWs)\n    // =====================================================================\n    function canReadItem(item) {\n        let isPublic = item.scope == 'public';\n        let isPrivateAndOwner = item.scope == 'private' && isOwner(item.userId);\n        let isProjectItemAndMember = item.scope == 'project' && isProjectMember(item.projectId);\n        \n        return isPublic || isPrivateAndOwner || isProjectItemAndMember;\n    }\n    \n    function canWriteItem() {\n        // User must be the owner of the document they are creating/updating.\n        return isSignedIn() && isOwner(request.resource.data.userId);\n    }\n\n    match /observations/{docId} {\n      allow get: if canReadItem(resource.data);\n      allow list: if isSignedIn(); // Broad list access, security enforced by queries + rules on 'get'\n      allow write: if canWriteItem();\n    }\n    \n    match /inspections/{docId} {\n      allow get: if canReadItem(resource.data);\n      allow list: if isSignedIn();\n      allow write: if canWriteItem();\n    }\n\n    match /ptws/{docId} {\n      allow get: if canReadItem(resource.data);\n      allow list: if isSignedIn();\n      allow write: if canWriteItem();\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T14:00:25.770Z] Jun 30, 2025 2:00:25 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 2:00:25 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T14:00:26.458Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T14:00:26.463Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T14:07:34.518Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T14:07:34.523Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper functions\n    function isSignedIn() {\n      return request.auth != null;\n    }\n\n    function isOwner(userId) {\n      return isSignedIn() && request.auth.uid == userId;\n    }\n\n    // =================================\n    // Users Collection\n    // =================================\n    match /users/{userId} {\n      // Any authenticated user can look up other users to invite them to projects.\n      // This is a security tradeoff for collaboration features without a complex backend.\n      allow list: if isSignedIn();\n\n      // A user can get their own profile.\n      allow get: if isSignedIn();\n      \n      // A user can update their own profile.\n      allow update: if isOwner(userId);\n      \n      // A new user profile is created during sign-up.\n      allow create: if isSignedIn();\n    }\n\n    // =================================\n    // Projects Collection\n    // =================================\n    match /projects/{projectId} {\n      // Anyone can create a project. The owner is set by the server action.\n      allow create: if isSignedIn();\n\n      // Users can read a project's data ONLY if their UID is in the memberUids list.\n      // This rule secures both direct gets and queries.\n      allow read: if isSignedIn() && request.auth.uid in resource.data.memberUids;\n\n      // Only the project owner can update a project (e.g., add members via a future function).\n      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.ownerUid;\n    }\n    \n    // =================================\n    // Shared Rules for Data Collections (Observations, Inspections, PTWs)\n    // =================================\n    function canReadItem(item) {\n      let isPublic = item.scope == 'public';\n      let isPrivateOwner = item.scope == 'private' && isOwner(item.userId);\n      let isProjectMember = item.scope == 'project' && get(/databases/$(database)/documents/projects/$(item.projectId)).data.memberUids.hasAny([request.auth.uid]);\n      \n      return isPublic || isPrivateOwner || isProjectMember;\n    }\n    \n    function canWriteItem() {\n       // Check if the projectId in the new data exists, if one is provided.\n      let projectExists = !request.resource.data.keys().hasAny(['projectId']) || request.resource.data.projectId == null || exists(/databases/$(database)/documents/projects/$(request.resource.data.projectId));\n      \n      // The user creating the resource must be the owner.\n      return isOwner(request.resource.data.userId) && projectExists;\n    }\n\n    // =================================\n    // Observations Collection\n    // =================================\n    match /observations/{obsId} {\n      allow read: if canReadItem(resource.data);\n      allow create: if canWriteItem();\n      // Only the owner of the observation can update it (e.g., take action).\n      allow update: if isOwner(resource.data.userId);\n    }\n    \n    // =================================\n    // Inspections Collection\n    // =================================\n    match /inspections/{inspId} {\n      allow read: if canReadItem(resource.data);\n      allow create: if canWriteItem();\n      allow update: if isOwner(resource.data.userId);\n    }\n\n    // =================================\n    // PTWs Collection\n    // =================================\n    match /ptws/{ptwId} {\n       allow read: if canReadItem(resource.data);\n       allow create: if canWriteItem();\n       // The PTW can be updated by the owner (e.g., submitting it) or by a project member (e.g., approving it).\n       allow update: if isOwner(resource.data.userId) || canReadItem(resource.data);\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T14:07:34.549Z] Jun 30, 2025 2:07:34 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 2:07:34 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T14:07:34.957Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T14:07:34.958Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T14:12:48.325Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T14:12:48.325Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper function to check for project membership.\n    // This is used for reading items within a project.\n    function isProjectMember(projectId) {\n      return request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids;\n    }\n\n    // Rules for User Profiles\n    match /users/{userId} {\n      // Any authenticated user can read any profile (for inviting members).\n      allow read: if request.auth != null;\n      // Users can only create their own profile document.\n      allow create: if request.auth.uid == userId;\n      // Users can only update their own profile.\n      allow update: if request.auth.uid == userId;\n    }\n    \n    // This is critical for allowing the project creation server action\n    // to search for users by email.\n    match /users/{document=**} {\n      allow list: if request.auth != null;\n    }\n\n    // Rules for Projects\n    match /projects/{projectId} {\n      // A user can read a project document if their UID is in the memberUids array.\n      // This is efficient and works directly with the `array-contains` query from the client.\n      allow read: if request.auth.uid in resource.data.memberUids;\n\n      // A user can create a project if they are the owner and their UID is in the initial member list.\n      allow create: if request.auth.uid == request.resource.data.ownerUid && request.auth.uid in request.resource.data.memberUids;\n      \n      // Only the owner can update a project (e.g., add members - NOT YET IMPLEMENTED).\n      allow update: if request.auth.uid == resource.data.ownerUid;\n      \n      // Only the owner can delete a project.\n      allow delete: if request.auth.uid == resource.data.ownerUid;\n    }\n\n    // Rules for Observations\n    match /observations/{obsId} {\n      allow create: if request.auth.uid == request.resource.data.userId;\n      // Allow read if: \n      // 1. It's a public observation.\n      // 2. The user is the owner of the observation.\n      // 3. The observation belongs to a project the user is a member of (checks for non-null projectId).\n      allow read: if resource.data.scope == 'public' || \n                     resource.data.userId == request.auth.uid || \n                     (resource.data.projectId != null && isProjectMember(resource.data.projectId));\n      allow update: if request.auth.uid == resource.data.userId || isProjectMember(resource.data.projectId);\n      allow delete: if request.auth.uid == resource.data.userId;\n    }\n\n    // Rules for Inspections\n    match /inspections/{inspId} {\n      allow create: if request.auth.uid == request.resource.data.userId;\n      allow read: if resource.data.scope == 'public' || \n                     resource.data.userId == request.auth.uid || \n                     (resource.data.projectId != null && isProjectMember(resource.data.projectId));\n      allow update: if request.auth.uid == resource.data.userId || isProjectMember(resource.data.projectId);\n      allow delete: if request.auth.uid == resource.data.userId;\n    }\n\n    // Rules for Permit to Work (PTW)\n    match /ptws/{ptwId} {\n      allow create: if request.auth.uid == request.resource.data.userId;\n      allow read: if resource.data.scope == 'public' || \n                     resource.data.userId == request.auth.uid || \n                     (resource.data.projectId != null && isProjectMember(resource.data.projectId));\n      // Any project member can approve/update a PTW.\n      allow update: if isProjectMember(resource.data.projectId);\n      allow delete: if request.auth.uid == resource.data.userId;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T14:12:48.347Z] Jun 30, 2025 2:12:48 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 2:12:48 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T14:12:48.659Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T14:12:48.660Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T14:21:48.212Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T14:21:48.215Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n  \n    // Helper function to check if a user is a member of a given project.\n    // This is used to secure reads for observations, inspections, and PTWs.\n    function isProjectMember(projectId) {\n      // Use `exists` for a lightweight check on the project document.\n      return exists(/databases/$(database)/documents/projects/$(projectId)) &&\n             request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids;\n    }\n\n    // Rules for the 'users' collection.\n    match /users/{userId} {\n      // A user can read or update their own profile.\n      allow read, update: if request.auth.uid == userId;\n      // Any authenticated user can list users, which is necessary for the\n      // project invitation feature to find users by email.\n      // The actual user data is still protected by the 'read' rule above.\n      allow list: if request.auth.uid != null;\n    }\n    \n    // Rules for the 'projects' collection.\n    match /projects/{projectId} {\n      // A user can create a project. The owner is set via server-side action.\n      allow create: if request.auth.uid != null;\n      // A user can read a project document only if their UID is in the memberUids list.\n      allow read: if request.auth.uid in resource.data.memberUids;\n      // Only the project owner can update project details (e.g., name, members).\n      allow update: if request.auth.uid == resource.data.ownerUid;\n      // Deleting projects is disabled for safety.\n      allow delete: if false;\n    }\n\n    // Rules for the 'observations' collection.\n    match /observations/{observationId} {\n      // Allow creating an observation if the user is authenticated.\n      allow create: if request.auth.uid != null;\n\n      // Allow reading an observation if:\n      // 1. It's public.\n      // 2. The user is the author.\n      // 3. The user is a member of the linked project.\n      allow read: if resource.data.scope == 'public' ||\n                   request.auth.uid == resource.data.userId ||\n                   (resource.data.projectId != null && isProjectMember(resource.data.projectId));\n                   \n      // Allow updating an observation (e.g., taking action) if the user is a member of the project\n      // or if it's a personal/public observation that they own.\n      allow update: if (resource.data.projectId != null && isProjectMember(resource.data.projectId)) ||\n                     (resource.data.projectId == null && request.auth.uid == resource.data.userId);\n\n      // Deleting observations is disabled for safety.\n      allow delete: if false;\n    }\n    \n    // Rules for the 'inspections' collection.\n    match /inspections/{inspectionId} {\n      allow create: if request.auth.uid != null;\n      allow read: if resource.data.scope == 'public' ||\n                   request.auth.uid == resource.data.userId ||\n                   (resource.data.projectId != null && isProjectMember(resource.data.projectId));\n      allow update: if false; // Updates for inspections are not a feature yet.\n      allow delete: if false;\n    }\n\n    // Rules for the 'ptws' (Permit to Work) collection.\n    match /ptws/{ptwId} {\n      allow create: if request.auth.uid != null;\n      \n      // Allow reading a PTW if it's public, the user submitted it, or they are a member of the project.\n      allow read: if resource.data.scope == 'public' ||\n                   request.auth.uid == resource.data.userId ||\n                   (resource.data.projectId != null && isProjectMember(resource.data.projectId));\n\n      // Only allow updating a PTW (e.g., approving it) if the user is a member of the associated project.\n      allow update: if resource.data.projectId != null && isProjectMember(resource.data.projectId);\n                   \n      allow delete: if false;\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T14:21:48.251Z] Jun 30, 2025 2:21:48 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 2:21:48 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T14:21:48.694Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T14:21:48.700Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {}
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T14:54:31.450Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T14:54:31.450Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper functions\n    function isSignedIn() {\n      return request.auth != null;\n    }\n\n    function isOwner(userId) {\n      return request.auth.uid == userId;\n    }\n\n    // --- User Profiles ---\n    // Users can be read by any authenticated user (to find emails for invites).\n    // Users can only be updated by themselves.\n    match /users/{userId} {\n      allow read: if isSignedIn();\n      allow write: if isOwner(userId);\n    }\n\n    // --- Projects ---\n    // Any signed-in user can create a project.\n    // Only members can read or update a project's details.\n    // Only the owner can delete a project.\n    match /projects/{projectId} {\n      function isMember() {\n        return request.auth.uid in resource.data.memberUids;\n      }\n\n      allow create: if isSignedIn();\n      allow read, update: if isMember();\n      allow delete: if request.auth.uid == resource.data.ownerUid;\n\n      // --- Project Subcollections ---\n      // This is the \"folder\" logic. Access is granted if the user is a member of the parent project.\n      match /{collectionName}/{docId}\n        where collectionName in ['observations', 'inspections', 'ptws'] {\n        function isProjectMemberFromPath() {\n          return request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids;\n        }\n        allow read, write: if isProjectMemberFromPath();\n      }\n    }\n\n    // --- Root Collections (for Public and Private items) ---\n    // This rule now applies only to the root collections for items not in a project.\n    match /{collectionName}/{docId}\n      where collectionName in ['observations', 'inspections', 'ptws'] {\n\n      // Allow anyone to read documents marked as 'public'.\n      // Allow authenticated users to read their own 'private' documents.\n      allow read: if resource.data.scope == 'public' || \n                   (resource.data.scope == 'private' && isOwner(resource.data.userId));\n\n      // An authenticated user can create a document, but they must set themselves as the owner.\n      allow create: if isSignedIn() && isOwner(request.resource.data.userId);\n\n      // Only the original owner can update or delete their documents.\n      allow update, delete: if isOwner(resource.data.userId);\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T14:54:31.476Z] Jun 30, 2025 2:54:31 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 2:54:31 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T14:54:31.527Z] Jun 30, 2025 2:54:31 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 2:54:31 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected HTTP/2 connection.\n"}}
[debug] [2025-06-30T14:54:31.678Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T14:54:31.678Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":39,"column":13,"currentOffset":1140,"endOffset":1140},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":40,"column":9,"currentOffset":1174,"endOffset":1178},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":40,"column":9,"currentOffset":1174,"endOffset":1178},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":50,"column":11,"currentOffset":1640,"endOffset":1640},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":51,"column":7,"currentOffset":1672,"endOffset":1676},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":51,"column":7,"currentOffset":1672,"endOffset":1676},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":64,"column":3,"currentOffset":2336,"endOffset":2336},"description":"Unexpected '}'.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:39:13 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:40:9 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:40:9 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:50:11 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:51:7 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:51:7 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:64:3 - ERROR Unexpected '}'. 
[info] ✔  firestore: Rules updated. 
[info] i  firestore: Change detected, updating rules... 
[debug] [2025-06-30T14:56:58.157Z] >>> [apiv2][query] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules [none]
[debug] [2025-06-30T14:56:58.158Z] >>> [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"ignore_errors":true,"rules":{"files":[{"name":"security.rules","content":"\nrules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Helper functions\n    function isSignedIn() {\n      return request.auth != null;\n    }\n\n    function isOwner(userId) {\n      return request.auth.uid == userId;\n    }\n\n    // --- User Profiles ---\n    // Users can be read by any authenticated user (to find emails for invites).\n    // Users can only be updated by themselves.\n    match /users/{userId} {\n      allow read: if isSignedIn();\n      allow write: if isOwner(userId);\n    }\n\n    // --- Projects ---\n    // Any signed-in user can create a project.\n    // Only members can read or update a project's details.\n    // Only the owner can delete a project.\n    match /projects/{projectId} {\n      function isMember() {\n        return request.auth.uid in resource.data.memberUids;\n      }\n\n      allow create: if isSignedIn();\n      allow read, update: if isMember();\n      allow delete: if request.auth.uid == resource.data.ownerUid;\n\n      // --- Project Subcollections ---\n      // This is the \"folder\" logic. Access is granted if the user is a member of the parent project.\n      match /{collectionName}/{docId}\n        where collectionName in ['observations', 'inspections', 'ptws'] {\n        function isProjectMemberFromPath() {\n          return request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids;\n        }\n        allow read, write: if isProjectMemberFromPath();\n      }\n    }\n\n    // --- Root Collections (for Public and Private items) ---\n    // This rule now applies only to the root collections for items not in a project.\n    match /{collectionName}/{docId}\n      where collectionName in ['observations', 'inspections', 'ptws'] {\n\n      // Allow anyone to read documents marked as 'public'.\n      // Allow authenticated users to read their own 'private' documents.\n      allow read: if resource.data.scope == 'public' || \n                   (resource.data.scope == 'private' && isOwner(resource.data.userId));\n\n      // An authenticated user can create a document, but they must set themselves as the owner.\n      allow create: if isSignedIn() && isOwner(request.resource.data.userId);\n\n      // Only the original owner can update or delete their documents.\n      allow update, delete: if isOwner(resource.data.userId);\n    }\n  }\n}\n"}]}}
[debug] [2025-06-30T14:56:58.186Z] Jun 30, 2025 2:56:58 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead
INFO: Detected non-HTTP/2 connection.
 {"metadata":{"emulator":{"name":"firestore"},"message":"Jun 30, 2025 2:56:58 PM io.gapi.emulators.netty.HttpVersionRoutingHandler channelRead\nINFO: Detected non-HTTP/2 connection.\n"}}
[debug] [2025-06-30T14:56:58.419Z] <<< [apiv2][status] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules 200
[debug] [2025-06-30T14:56:58.420Z] <<< [apiv2][body] PUT http://127.0.0.1:8080/emulator/v1/projects/demo-app:securityRules {"issues":[{"sourcePosition":{"fileName":"security.rules","line":39,"column":13,"currentOffset":1140,"endOffset":1140},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":40,"column":9,"currentOffset":1174,"endOffset":1178},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":40,"column":9,"currentOffset":1174,"endOffset":1178},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":50,"column":11,"currentOffset":1640,"endOffset":1640},"description":"Missing 'match' keyword before path.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":51,"column":7,"currentOffset":1672,"endOffset":1676},"description":"Unexpected 'where'.","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":51,"column":7,"currentOffset":1672,"endOffset":1676},"description":"mismatched input 'where' expecting {'{', '/', PATH_SEGMENT}","severity":"ERROR"},{"sourcePosition":{"fileName":"security.rules","line":64,"column":3,"currentOffset":2336,"endOffset":2336},"description":"Unexpected '}'.","severity":"ERROR"}]}
[warn] ⚠  firestore.rules:39:13 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:40:9 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:40:9 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:50:11 - ERROR Missing 'match' keyword before path. 
[warn] ⚠  firestore.rules:51:7 - ERROR Unexpected 'where'. 
[warn] ⚠  firestore.rules:51:7 - ERROR mismatched input 'where' expecting {'{', '/', PATH_SEGMENT} 
[warn] ⚠  firestore.rules:64:3 - ERROR Unexpected '}'. 
[info] ✔  firestore: Rules updated. 

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =================================
    // Global Functions
    // =================================
    function isSuperAdmin() {
      return request.auth.uid == 'GzR8FeByeKhJ0vZoeo5Zj4M0Ftl2';
    }
    
    function isSignedIn() {
      return request.auth != null;
    }

    // =================================
    // Users Collection
    // =================================
    match /users/{userId} {
      // Users can read and update their own profile. Super admin can read/update any profile.
      allow read, update: if request.auth.uid == userId || isSuperAdmin();
      // Any authenticated user can create their own user document upon sign-up.
      allow create: if isSignedIn();
    }

    // =================================
    // Projects Collection
    // =================================
    match /projects/{projectId} {
      // Allow read (get and list) IF user is super admin OR their UID is in that project's memberUids array.
      // Using get() is the correct and robust way to secure LIST queries based on document content.
      allow read: if isSuperAdmin() || 
                   (request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids);
      
      // Allow creating a project for any signed-in user. The owner is set client-side.
      allow create: if isSignedIn();
      
      // Allow updating or deleting a project only for the project owner or super admin.
      allow update, delete: if isSuperAdmin() || request.auth.uid == resource.data.ownerUid;
    }
    
    // =================================
    // Generic Rule for All Data Items (Observations, Inspections, PTWs)
    // =================================
    match /{itemCollection}/{itemId} {
      // This rule applies to 'observations', 'inspections', and 'ptws' collections.
      // Allow read access IF:
      // 1. The user is a Super Admin.
      // OR 2. The item is marked as 'public'.
      // OR 3. The item is 'private' and belongs to the user.
      // OR 4. The item is in a 'project' and the user is a member of that project.
      allow read: if isSuperAdmin() ||
                   resource.data.scope == 'public' ||
                   (resource.data.scope == 'private' && resource.data.userId == request.auth.uid) ||
                   (resource.data.scope == 'project' && request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.memberUids);

      // Any signed-in user can create an item. Scope/project is set client-side.
      allow create: if isSignedIn();
      
      // Only the user who created the item or a super admin can update it.
      allow update: if isSuperAdmin() || request.auth.uid == resource.data.userId;
    }
  }
}

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default deny all to prevent accidental access
    match /{document=**} {
      allow read, write: if false;
    }

    // Users can only manage their own profile
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
    }

    // Projects:
    // ANY authenticated user can READ any project document. This is required for the 
    // "fetch all and filter" search functionality to work without a manual index.
    // WRITE permissions are much more restrictive.
    match /projects/{projectId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      // Only the project owner can update or delete the project document.
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.ownerUid;
    }

    // Rules for subcollections remain secure.
    // For now, allow any logged-in user to access these items.
    // This can be refined later to check for project membership.
    match /observations/{observationId} {
      allow read, write: if request.auth != null;
    }
    match /inspections/{inspectionId} {
       allow read, write: if request.auth != null;
    }
    match /ptws/{ptwId} {
       allow read, write: if request.auth != null;
    }
  }
}

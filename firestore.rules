rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // Correctly checks if the requesting user is a member of a given project.
    // This was the source of a critical bug.
    function isProjectMember(projectId) {
      // The `get()` call reads the project document.
      // We check if the user's UID is present in the `memberUids` array using the `in` operator.
      return isSignedIn() && projectId != null && request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids;
    }

    // --- Collection Rules ---

    // Users: Can only read/update their own profile. Authenticated users can list them for invites.
    match /users/{userId} {
      allow read, update: if isUser(userId);
      // This allows the createProject server action to find users by email.
      allow list: if isSignedIn(); 
    }

    // Projects: Members can read/update. Only the owner can create.
    match /projects/{projectId} {
      allow read, update: if isProjectMember(projectId);
      allow create: if isSignedIn() && 
                     request.resource.data.ownerUid == request.auth.uid && 
                     request.auth.uid in request.resource.data.memberUids;
    }

    // Generic Rules for all item collections (observations, inspections, ptws)
    match /{itemCollection}/{itemId} {
       // READ: An item can be read if:
       // 1. It's public.
       // 2. It's private AND you are the owner.
       // 3. It's a project item AND you are a member of that project.
       allow read: if resource.data.scope == 'public' ||
                      (resource.data.scope == 'private' && isUser(resource.data.userId)) || 
                      (resource.data.scope == 'project' && isProjectMember(resource.data.projectId));

       // CREATE: An item can be created if you are signed in and you are the author.
       allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

       // UPDATE: An item can be updated if you are the original author OR a member of its project.
       allow update: if isUser(resource.data.userId) || isProjectMember(resource.data.projectId);
       
       // DELETE: Only the creator can delete their own reports.
       allow delete: if isUser(resource.data.userId);
    }
  }
}

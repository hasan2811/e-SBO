
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      // Pengguna hanya bisa membaca dan mengubah data profil mereka sendiri.
      allow read, update: if request.auth.uid == userId;
    }

    match /projects/{projectId} {
      // Aturan BARU & TAHAN BANTING:
      // Izinkan pengguna membaca dokumen proyek JIKA DAN HANYA JIKA:
      // 1. Dokumen tersebut memiliki field 'memberUids'.
      // 2. DAN ID pengguna yang login ada di dalam daftar 'memberUids' tersebut.
      // Aturan ini aman dan akan berfungsi untuk mengambil daftar maupun satu dokumen.
      allow read: if 'memberUids' in resource.data && request.auth.uid in resource.data.memberUids;
      
      // Siapa pun yang login dapat membuat proyek.
      allow create: if request.auth != null;

      // Hanya pemilik proyek yang dapat mengubah atau menghapusnya.
      allow update, delete: if request.auth.uid == resource.data.ownerUid;
    }
    
    // Aturan untuk semua koleksi lain (observations, inspections, ptw)
    match /{collection}/{id} {
        // Izinkan siapa pun membaca dokumen (penting untuk feed publik).
        allow read: if true;

        // Hanya pengguna yang login yang bisa menulis (membuat, mengubah, menghapus).
        allow write: if request.auth != null;
    }
  }
}

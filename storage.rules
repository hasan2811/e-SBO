
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper function to check project membership
    function isProjectMember(projectId) {
      return get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids.has(request.auth.uid);
    }
    
    // --- PRIVATE UPLOADS ---
    // Users can only write to their own private folders.
    // This rule covers 'observations', 'inspections', 'ptw-jsa', and 'actions' folders.
    match /{path}/{userId}/{allPaths=**} {
      allow read: if true; // All uploaded files are public-readable via URL
      allow write: if request.auth.uid == userId;
    }

    // --- PROJECT UPLOADS ---
    // Users can only write to a project's folder if they are a member of that project.
    // They are further restricted to writing inside their own user-specific subfolder.
    match /projects/{projectId}/{path}/{userId}/{allPaths=**} {
      allow read: if true; // All uploaded files are public-readable via URL
      allow write: if request.auth.uid == userId && isProjectMember(projectId);
    }
  }
}
